<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Brand Strategy Deck Generator</title>
    
    <!-- 1. Áí∞Â¢ÉÊ®°Êì¨ -->
    <script>
        window.process = { env: { NODE_ENV: 'production' } };
    </script>

    <!-- 2. Ê†∏ÂøÉ React Â∫´ (‰ΩøÁî® React 17 Á©©ÂÆöÁâà) -->
    <script crossorigin src="https://unpkg.com/react@17.0.2/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17.0.2/umd/react-dom.production.min.js"></script>
    
    <!-- 3. ÈóúÈçµÁõ∏ÂÆπÊÄßË£ú‰∏Å -->
    <script>
        if (window.React && !window.React.default) {
            window.React.default = window.React;
        }
        if (window.ReactDOM && !window.ReactDOM.default) {
            window.ReactDOM.default = window.ReactDOM;
        }
    </script>

    <!-- 4. Babel Ëß£ÊûêÂô® -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    
    <!-- 5. Ê®£ÂºèÂ∫´ -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 6. Recharts ‰æùË≥¥ËàáÂ∫´ (ÈéñÂÆö 2.1.0 Á©©ÂÆöÁâà) -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.1.0/umd/Recharts.min.js"></script>
    
    <!-- 7. PDF ÁîüÊàêÂ∫´ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- 8. ÈåØË™§Ë®äÊÅØÊäëÂà∂ -->
    <script>
        const originalError = console.error;
        console.error = function(...args) {
            const msg = args[0];
            if (typeof msg === 'string' && (
                msg.includes('defaultProps') || 
                msg.includes('validateDOMNesting') ||
                msg.includes('Support for defaultProps') ||
                msg.includes('componentWillReceiveProps')
            )) return;
            originalError.apply(console, args);
        };
    </script>

    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.5s ease-out forwards; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans antialiased">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- ÂÖßÂª∫ SVG ÂúñÁ§∫ ---
        const Icons = {
            Globe: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg>,
            Target: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>,
            Users: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            BarChart2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="18" x2="18" y1="20" y2="10"/><line x1="12" x2="12" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="14"/></svg>,
            Layout: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><line x1="3" x2="21" y1="9" y2="9"/><line x1="9" x2="9" y1="21" y2="9"/></svg>,
            Zap: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
            Save: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            Presentation: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M2 3h20"/><path d="M21 3v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V3"/><path d="m7 21 5-5 5 5"/></svg>,
            Sparkles: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M2 7h4"/><path d="M2 17h4"/><path d="M5 17v4"/><path d="M9 17v4"/></svg>,
            Key: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="7.5" cy="15.5" r="5.5"/><path d="m21 2-9.6 9.6"/><path d="m15.5 7.5 3 3L22 7l-3-3"/></svg>,
            Loader2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
            Search: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/></svg>,
            AlertCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
            CheckCircle2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>,
            Shield: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>,
            TrendingUp: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
            TrendingDown: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></svg>,
            AlertTriangle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>,
            Flame: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg>,
            Newspaper: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2"/><path d="M18 14h-8"/><path d="M15 18h-5"/><path d="M10 6h8"/></svg>,
            Briefcase: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>,
            Plus: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></svg>,
            Trash2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Crosshair: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><line x1="22" x2="18" y1="12" y2="12"/><line x1="6" x2="2" y1="12" y2="12"/><line x1="12" x2="12" y1="6" y2="2"/><line x1="12" x2="12" y1="22" y2="18"/></svg>,
            Info: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12.01" y1="8" y2="8"/></svg>,
            Lock: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        };

        // API Key
        const apiKey = "AIzaSyCtqIBs6pKwtnD3NcJwYpAYnVhLhJV6y_Q"; 

        const getLast6MonthsLabels = () => {
            const labels = [];
            for (let i = 5; i >= 0; i--) {
                const d = new Date();
                d.setMonth(d.getMonth() - i);
                const monthStr = `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(2, '0')}`;
                labels.push(monthStr);
            }
            return labels;
        };

        const getScoreLabel = (score, type) => {
            const s = Number(score);
            if (type === 'price') {
                if (s < 40) return 'Ë¶™Ê∞ëÂπ≥ÂÉπ';
                if (s < 75) return '‰∏≠ÂÉπ‰Ωç';
                return 'È´òÂñÆÂÉπ';
            }
            if (type === 'quality') {
                if (s < 40) return 'Â§ßÁúæÊ®ôÊ∫ñ';
                if (s < 75) return 'Ë≥™ÊÑüÂÑ™ËâØ';
                return 'È†ÇÁ¥öÁ≤æÂìÅ';
            }
            if (type === 'brandHeat') {
                if (s < 40) return 'ÊΩõÂäõÂ∞èÁúæ';
                if (s < 75) return 'ÂÖ∑Áü•ÂêçÂ∫¶';
                return 'Â∏ÇÂ†¥ÁÜ±ÈñÄ';
            }
            return s;
        };

        const getTypeColor = (type) => {
            switch(type) {
                case 'Êú¨ÂìÅÁâå': return '#22c55e'; 
                case 'ÂêåÈ°ûÂûã': return '#3b82f6'; 
                case 'ÂêåÂúãÂÆ∂': return '#a855f7'; 
                case 'ÂêåÈ¢®Ê†º': return '#f97316'; 
                default: return '#8884d8'; 
            }
        };

        const BMC_TITLES = {
            partners: 'ÈóúÈçµÂêà‰ΩúÂ§•‰º¥ (Key Partners)',
            activities: 'ÈóúÈçµÊ¥ªÂãï (Key Activities)',
            resources: 'ÈóúÈçµË≥áÊ∫ê (Key Resources)',
            valueProp: 'ÂÉπÂÄº‰∏ªÂºµ (Value Propositions)',
            relationships: 'È°ßÂÆ¢Èóú‰øÇ (Customer Relationships)',
            channels: 'ÈÄöË∑Ø (Channels)',
            segments: 'ÁõÆÊ®ôÂÆ¢Áæ§ (Customer Segments)',
            costStructure: 'ÊàêÊú¨ÁµêÊßã (Cost Structure)',
            revenueStreams: 'Êî∂ÁõäÊµÅ (Revenue Streams)'
        };

        const initialData = {
            brandName: "",
            searchQuery: "",
            marketScope: "local",
            intelligence: {
                sentiment: { positive: 0, neutral: 0, negative: 0 },
                keywords: [],
                summary: "Â∞öÊú™ÈÄ≤Ë°åÂàÜÊûê...",
                monthlySearchVolume: [0, 0, 0, 0, 0, 0],
                trendLabels: getLast6MonthsLabels(),
                competitorNews: [],
                swot: { strengths: [], weaknesses: [], opportunities: [], threats: [] }
            },
            positioning: {
                vision: "", mission: "", values: "",
                attributes: [
                    { subject: 'ÂÉπÊ†ºË¶™Ê∞ë', A: 50, fullMark: 100 },
                    { subject: 'ÂìÅË≥™È´òÁ´Ø', A: 50, fullMark: 100 },
                    { subject: 'Áí∞Â¢ÉËàíÈÅ©', A: 50, fullMark: 100 },
                    { subject: 'ÂìÅÁâåÁÜ±Â∫¶', A: 50, fullMark: 100 },
                    { subject: 'ÂâµÊñ∞Á®ãÂ∫¶', A: 50, fullMark: 100 },
                    { subject: 'ÂìÅÁâåÁü•ÂêçÂ∫¶', A: 50, fullMark: 100 },
                ]
            },
            targetAudience: [
                { id: 1, name: "ÂæÖÂàÜÊûêÂÆ¢Áæ§ A", age: "??-??", income: "???", painPoint: "Á≠âÂæÖ AI ÂàÜÊûê...", hobby: "???" },
            ],
            competitors: [ { name: "Ëá™ÂÆ∂ÂìÅÁâå", type: "Êú¨ÂìÅÁâå", price: 50, quality: 50, brandHeat: 50, feature: "Â∞öÊú™ÂàÜÊûê" } ],
            businessModel: {
                partners: [], activities: [], resources: [], valueProp: [],
                relationships: [], channels: [], segments: [], costStructure: [], revenueStreams: []
            }
        };

        const Card = ({ children, className = "" }) => <div className={`bg-white rounded-xl shadow-sm border border-slate-200 p-6 ${className}`}>{children}</div>;

        const SectionTitle = ({ icon: IconComp, title, subtitle }) => (
            <div className="mb-6">
                <div className="flex items-center gap-2 text-blue-600 mb-1">
                    {IconComp && <IconComp size={24} />}
                    <h2 className="text-xl font-bold">{title}</h2>
                </div>
                <p className="text-slate-500 text-sm">{subtitle}</p>
            </div>
        );

        function BrandStrategyApp() {
            const [activeTab, setActiveTab] = useState('intelligence');
            const [isPresentationMode, setIsPresentationMode] = useState(false);
            const [data, setData] = useState(initialData);
            const [customApiKey, setCustomApiKey] = useState('');
            
            const [searchStatus, setSearchStatus] = useState('idle');
            const [searchLog, setSearchLog] = useState([]);
            const [errorMsg, setErrorMsg] = useState(null);
            const [rawAiResponse, setRawAiResponse] = useState('');
            const [isRechartsLoaded, setIsRechartsLoaded] = useState(false);

            useEffect(() => {
                const checkRecharts = () => {
                    if (window.Recharts) {
                        setIsRechartsLoaded(true);
                    } else {
                        setTimeout(checkRecharts, 300);
                    }
                };
                checkRecharts();
            }, []);

            const navItems = [
                { id: 'intelligence', label: 'Ê∑±Â∫¶ÊÉÖË≥áËàá SWOT', icon: Icons.Globe },
                { id: 'positioning', label: 'ÂìÅÁâåÂÆö‰Ωç (Positioning)', icon: Icons.Target },
                { id: 'audience', label: 'ÁõÆÊ®ôÂÆ¢Áæ§ (TA)', icon: Icons.Users },
                { id: 'competitors', label: 'Á´∂ÂìÅÂàÜÊûê (Competitors)', icon: Icons.BarChart2 },
                { id: 'businessModel', label: 'ÂïÜÊ•≠Ê®°Âºè (BMC)', icon: Icons.Layout },
            ];

            // Âº∑ÂÅ•ÁöÑ JSON Ëß£ÊûêÂô®
            const parseJSON = (text) => {
                if (!text) throw new Error("AI Êú™ÂõûÂÇ≥‰ªª‰ΩïÂÖßÂÆπ");

                let cleaned = text.trim();
                // ÁßªÈô§ Markdown Ê®ôË®ò
                cleaned = cleaned.replace(/^```json\s*/i, '').replace(/^```\s*/i, '').replace(/```$/i, '');
                
                // Â∞ãÊâæÊã¨Ëôü
                const firstBrace = cleaned.indexOf('{');
                const lastBrace = cleaned.lastIndexOf('}');
                
                if (firstBrace !== -1 && lastBrace !== -1) {
                    cleaned = cleaned.substring(firstBrace, lastBrace + 1);
                } else {
                    throw new Error("ÁÑ°Ê≥ïË≠òÂà• JSON ÁµêÊßã");
                }

                // ÂòóË©¶‰øÆÂæ©Â∞æÈö®ÈÄóËôü
                const fixed = cleaned.replace(/,(\s*[\]}])/g, '$1');

                try {
                    return JSON.parse(fixed);
                } catch (e) {
                    try {
                        return JSON.parse(cleaned);
                    } catch (e2) {
                         throw new Error(`JSON Ê†ºÂºèÈåØË™§: ${e2.message}`);
                    }
                }
            };

            const fetchGeminiAnalysis = async (query, scope) => {
                const validApiKey = apiKey || customApiKey;
                if (!validApiKey) throw new Error("Ë´ãËº∏ÂÖ• Google API Key");

                const prompt = `
                Role: Senior Brand Strategist.
                Task: Analyze brand "${query}" in ${scope === 'local' ? 'Taiwan' : 'Global'} market.
                
                CRITICAL INSTRUCTION:
                - Return ONLY valid JSON.
                - Content in Traditional Chinese.
                - NO trailing commas.
                
                REQUIRED SCORING LOGIC for Competitor Pricing:
                - Mass Market (e.g., Uniqlo, Zara): 10-35 points.
                - Mid-tier/Indie (e.g., Carhartt WIP): 40-65 points.
                - High-End Street/Designer (e.g., Supreme, WTAPS): 65-85 points.
                - Luxury/Select Shop (e.g., INVINCIBLE, Kith, Visvim): 85-100 points.
                * INVINCIBLE must be scored significantly higher (>80) than mid-tier brands.

                Required JSON Structure:
                {
                    "brandName": "${query}",
                    "intelligence": {
                        "sentiment": { "positive": 70, "neutral": 20, "negative": 10 },
                        "keywords": ["k1", "k2", "k3", "k4", "k5"],
                        "summary": "Summary...",
                        "competitorNews": [{ "source": "Source", "title": "Title", "date": "YYYY-MM-DD" }],
                        "swot": {
                            "strengths": ["S1", "S2", "S3"],
                            "weaknesses": ["W1", "W2", "W3"],
                            "opportunities": ["O1", "O2", "O3"],
                            "threats": ["T1", "T2", "T3"]
                        }
                    },
                    "positioning": {
                        "vision": "Vision", "mission": "Mission", "values": "Values",
                        "attributes": [
                            { "subject": "ÂÉπÊ†ºË¶™Ê∞ë", "A": 50, "fullMark": 100 },
                            { "subject": "ÂìÅË≥™È´òÁ´Ø", "A": 80, "fullMark": 100 },
                            { "subject": "Áí∞Â¢ÉËàíÈÅ©", "A": 70, "fullMark": 100 },
                            { "subject": "ÂìÅÁâåÁÜ±Â∫¶", "A": 60, "fullMark": 100 },
                            { "subject": "ÂâµÊñ∞Á®ãÂ∫¶", "A": 60, "fullMark": 100 },
                            { "subject": "ÂìÅÁâåÁü•ÂêçÂ∫¶", "A": 80, "fullMark": 100 }
                        ]
                    },
                    "competitors": [
                        { "name": "Competitor A", "type": "ÂêåÈ°ûÂûã", "feature": "Feature", "price": 80, "quality": 70, "brandHeat": 90 }
                    ],
                    "targetAudience": [
                        { "id": 1, "name": "Persona", "age": "25-30Ê≠≤", "income": "4-5Ëê¨", "painPoint": "Pain", "hobby": "Hobby" }
                    ],
                    "businessModel": {
                        "partners": ["P1"], "activities": ["A1"], "resources": ["R1"], "valueProp": ["V1"],
                        "relationships": ["Rel1"], "channels": ["Ch1"], "segments": ["Seg1"],
                        "costStructure": ["C1"], "revenueStreams": ["Rev1"]
                    }
                }

                Requirements:
                1. Find at least 8 competitors.
                2. **Provide 3 to 6 detailed Personas** in "targetAudience" array.
                3. Fill all 9 blocks of BMC.
                `;

                try {
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${validApiKey}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: prompt }] }],
                                tools: [{ google_search: {} }]
                            })
                        }
                    );

                    if (response.status !== 200) {
                        const errText = await response.text();
                        throw new Error(`API Error (${response.status}): ${errText}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (!text) throw new Error("No content generated from AI");
                    setRawAiResponse(text); 

                    return parseJSON(text);

                } catch (error) {
                    console.error("Fetch Error:", error);
                    throw error;
                }
            };

            const handleSearch = async () => {
                if (!data.searchQuery) return;
                setSearchStatus('searching');
                setSearchLog([]);
                setErrorMsg(null);
                setRawAiResponse('');
                
                try {
                    setSearchLog(prev => [...prev, `üîç Ê∑±Â∫¶ÊêúÂ∞ã "${data.searchQuery}" ...`]);
                    const result = await fetchGeminiAnalysis(data.searchQuery, data.marketScope);
                    
                    setSearchLog(prev => [...prev, "üß† ÈÄ≤Ë°å SWOT ËàáÁ´∂ÂìÅÂàÜÊûê..."]);
                    setSearchStatus('synthesizing');
                    await new Promise(r => setTimeout(r, 800));
                    setSearchLog(prev => [...prev, "‚úÖ ÂàÜÊûêÂÆåÊàêÔºÅ"]);

                    const safeNumber = (v) => Number(v) || 50;
                    
                    // ÂÆâÂÖ®Âú∞ËôïÁêÜ competitors Èô£Âàó (Èò≤Ê≠¢ undefined)
                    const competitorsList = Array.isArray(result.competitors) ? result.competitors : [];
                    const newCompetitors = competitorsList.map(c => ({
                        name: c.name || "Êú™Áü•Âêç",
                        type: c.type || "Êú™ÂàÜÈ°û",
                        feature: c.feature || "",
                        price: safeNumber(c.price),
                        quality: safeNumber(c.quality),
                        brandHeat: safeNumber(c.brandHeat)
                    }));

                    const getAttr = (key) => {
                        if (!result.positioning || !result.positioning.attributes) return 50;
                        const found = result.positioning.attributes.find(a => a.subject && a.subject.includes(key));
                        return found ? safeNumber(found.A) : 50;
                    };
                    
                    newCompetitors.push({
                        name: result.brandName,
                        type: "Êú¨ÂìÅÁâå",
                        feature: "ÊÇ®ÁöÑÂìÅÁâå",
                        price: getAttr('ÂÉπÊ†º'),
                        quality: getAttr('ÂìÅË≥™'),
                        brandHeat: getAttr('ÁÜ±Â∫¶')
                    });

                    // ÂÆâÂÖ®ËôïÁêÜ targetAudience
                    let newAudience = data.targetAudience;
                    if (Array.isArray(result.targetAudience)) {
                         newAudience = result.targetAudience.map((ta, index) => ({...ta, id: index + 1}));
                    } else if (Array.isArray(result.target_audience)) {
                         newAudience = result.target_audience.map((ta, index) => ({...ta, id: index + 1}));
                    }

                    const safeBMC = result.businessModel || data.businessModel;

                    setData(prev => ({
                        ...prev,
                        brandName: result.brandName,
                        intelligence: {
                            ...prev.intelligence,
                            ...result.intelligence,
                            monthlySearchVolume: Array.from({length: 6}, () => Math.floor(Math.random() * 60) + 40),
                            trendLabels: getLast6MonthsLabels(),
                            swot: {
                                strengths: result.intelligence?.swot?.strengths || ["ÁÑ°Ë≥áÊñô"],
                                weaknesses: result.intelligence?.swot?.weaknesses || ["ÁÑ°Ë≥áÊñô"],
                                opportunities: result.intelligence?.swot?.opportunities || ["ÁÑ°Ë≥áÊñô"],
                                threats: result.intelligence?.swot?.threats || ["ÁÑ°Ë≥áÊñô"]
                            }
                        },
                        positioning: result.positioning || prev.positioning,
                        competitors: newCompetitors,
                        targetAudience: newAudience,
                        businessModel: safeBMC
                    }));
                    setSearchStatus('complete');
                } catch (err) {
                    setErrorMsg(err.message);
                    setSearchStatus('idle');
                }
            };

            const handleDownloadPDF = async () => {
                const element = document.getElementById('pdf-export-target');
                if (!element) return;

                const btn = document.getElementById('download-btn');
                const originalText = btn.innerText;
                btn.innerText = 'ÁîüÊàê‰∏≠...';
                btn.disabled = true;

                try {
                    const canvas = await window.html2canvas(element, {
                        scale: 2,
                        useCORS: true, 
                        logging: false
                    });

                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('l', 'mm', 'a4');
                    
                    const imgProps = pdf.getImageProperties(imgData);
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                    
                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                    pdf.save(`${data.brandName || 'Brand_Strategy'}_Report.pdf`);

                } catch (err) {
                    console.error('PDF Export Error:', err);
                    alert('PDF ÁîüÊàêÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ');
                } finally {
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            };

            const handleNestedChange = (section, field, value) => {
                setData(prev => ({ ...prev, [section]: { ...prev[section], [field]: value } }));
            };

            const handleAttributeChange = (index, value) => {
                const newAttributes = [...data.positioning.attributes];
                newAttributes[index].A = Number(value);
                setData(prev => ({ ...prev, positioning: { ...prev.positioning, attributes: newAttributes } }));
            };

            // Recharts 1.8.5 ÂÆâÂÖ®Ê∏≤ÊüìÁµÑ‰ª∂
            const SafeChart = ({ type, children, ...props }) => {
                if (!window.Recharts) return <div className="flex items-center justify-center h-full text-slate-400 text-xs">ÂúñË°®ËºâÂÖ•‰∏≠...</div>;
                const R = window.Recharts;
                const ChartComponent = R[type];
                if (!ChartComponent) return null;
                
                // 1.8.5 ÂøÖÈ†àÊåáÂÆöÊòéÁ¢∫È´òÂ∫¶ (ÈáçË¶Å)
                const containerStyle = { height: '100%', minHeight: '300px', width: '100%' };

                if (type === 'RadarChart') {
                    return (
                        <div style={containerStyle}>
                            <R.ResponsiveContainer>
                                <ChartComponent {...props}>
                                    <R.PolarGrid />
                                    <R.PolarAngleAxis dataKey="subject" tick={{ fill: '#64748b', fontSize: 12 }} />
                                    <R.PolarRadiusAxis angle={30} domain={[0, 100]} />
                                    <R.Radar name={data.brandName} dataKey="A" stroke="#2563eb" strokeWidth={3} fill="#3b82f6" fillOpacity={0.4} />
                                    <R.Tooltip />
                                </ChartComponent>
                            </R.ResponsiveContainer>
                        </div>
                    );
                }

                if (type === 'AreaChart') {
                    return (
                         <div style={containerStyle}>
                            <R.ResponsiveContainer>
                                <ChartComponent {...props}>
                                    <defs><linearGradient id="colorVol" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#4f46e5" stopOpacity={0.2}/><stop offset="95%" stopColor="#4f46e5" stopOpacity={0}/></linearGradient></defs>
                                    <R.CartesianGrid strokeDasharray="3 3" vertical={false} />
                                    <R.XAxis dataKey="name" tick={{fontSize: 10}} tickLine={false} axisLine={false} />
                                    <R.YAxis tick={{fontSize: 10}} axisLine={false} tickLine={false} label={{ value: 'ÁÜ±Â∫¶', angle: -90, position: 'insideLeft', fontSize: 10, fill: '#94a3b8' }} />
                                    <R.Tooltip contentStyle={{borderRadius: '8px', border: 'none'}} />
                                    <R.Area type="monotone" dataKey="value" stroke="#4f46e5" fillOpacity={1} fill="url(#colorVol)" />
                                </ChartComponent>
                            </R.ResponsiveContainer>
                        </div>
                    );
                }
                
                if (type === 'ScatterChart') {
                    return (
                         <div style={containerStyle}>
                            <R.ResponsiveContainer>
                                <ChartComponent margin={{ top: 20, right: 30, bottom: 20, left: 20 }}>
                                    <R.CartesianGrid strokeDasharray="3 3" />
                                    <R.XAxis type="number" dataKey="price" name="ÂÉπÊ†º" domain={[0, 100]} label={{ value: 'ÂÉπÊ†º', position: 'bottom', offset: 0, fontSize: 12 }} tick={{fontSize: 10}} />
                                    <R.YAxis type="number" dataKey="quality" name="ÂìÅË≥™" domain={[0, 100]} label={{ value: 'ÂìÅË≥™', angle: -90, position: 'left', fontSize: 12 }} tick={{fontSize: 10}} />
                                    <R.ZAxis type="number" dataKey="brandHeat" range={[100, 1000]} name="ÁÜ±Â∫¶" />
                                    <R.Tooltip cursor={{ strokeDasharray: '3 3' }} content={({ active, payload }) => {
                                        if (active && payload && payload.length) {
                                            const d = payload[0].payload;
                                            return (
                                                <div className="bg-white p-2 border border-slate-200 rounded shadow text-xs">
                                                    <p className="font-bold mb-1" style={{color: getTypeColor(d.type)}}>{d.name} <span className="text-[10px] px-1 bg-slate-100 rounded text-slate-500 ml-1">{d.type || 'Êú™ÂàÜÈ°û'}</span></p>
                                                    <p className="text-xs text-gray-500 mb-1">"{d.feature || ''}"</p>
                                                    <hr className="my-1 border-slate-100"/>
                                                    <p>ÂÉπÊ†º: {getScoreLabel(d.price, 'price')} ({d.price})</p>
                                                    <p>ÂìÅË≥™: {getScoreLabel(d.quality, 'quality')} ({d.quality})</p>
                                                    <p className="text-red-500">ÁÜ±Â∫¶: {getScoreLabel(d.brandHeat, 'brandHeat')} ({d.brandHeat})</p>
                                                </div>
                                            );
                                        }
                                        return null;
                                    }} />
                                    <R.Legend />
                                    {/* Recharts 1.8.5 ÁöÑ Scatter ÂØ´Ê≥ï */}
                                    <R.Scatter name="Â∏ÇÂ†¥ÂìÅÁâå" data={data.competitors} fill="#8884d8">
                                        {data.competitors.map((entry, index) => (
                                            <R.Cell key={`cell-${index}`} fill={getTypeColor(entry.type)} />
                                        ))}
                                        <R.LabelList dataKey="name" position="top" style={{ fill: '#555', fontSize: '10px', fontWeight: 'bold' }}/>
                                    </R.Scatter>
                                </ChartComponent>
                            </R.ResponsiveContainer>
                        </div>
                    );
                }

                return null;
            };


            const renderEditor = () => {
                const { swot } = data.intelligence;
                switch (activeTab) {
                    case 'intelligence':
                        return (
                            <div className="space-y-6 animate-fadeIn pb-20 md:pb-0">
                                <SectionTitle icon={Icons.Globe} title="ÂìÅÁâåÊ∑±Â∫¶ÊÉÖË≥áËàá SWOT" subtitle="ÂÖ®Êñπ‰ΩçÂ∏ÇÂ†¥ÊéÉÊèè" />
                                <div className="bg-gradient-to-br from-indigo-50 to-blue-50 p-4 rounded-xl border border-indigo-100 shadow-sm space-y-4">
                                    <div className="flex justify-between items-start mb-2">
                                        <label className="text-sm font-bold text-indigo-900 flex items-center gap-2"><Icons.Sparkles size={16}/> AI Ê∑±Â∫¶ÂàÜÊûê</label>
                                        
                                        {apiKey ? (
                                            <div className="flex items-center gap-2 bg-green-100 p-1.5 rounded border border-green-200 text-green-700 text-xs font-bold">
                                                <Icons.Lock size={14} /> Á≥ªÁµ±ÊéàÊ¨äÂ∑≤ÈÄ£Áµê
                                            </div>
                                        ) : (
                                            <div className="flex items-center gap-2 bg-white/60 p-1 rounded border border-indigo-100">
                                                <Icons.Key size={14} className="text-indigo-400" />
                                                <input type="password" placeholder="Ë´ãËº∏ÂÖ• Key" value={customApiKey} onChange={(e) => setCustomApiKey(e.target.value)} className="bg-transparent text-xs outline-none w-24" />
                                            </div>
                                        )}
                                    </div>
                                    <div className="flex gap-2">
                                        <input className="flex-1 border border-indigo-200 rounded-lg p-2 text-sm" placeholder="Ëº∏ÂÖ•ÂìÅÁâåÂêçÁ®±..." value={data.searchQuery} onChange={(e)=>setData({...data, searchQuery:e.target.value})} />
                                        <button onClick={handleSearch} disabled={!data.searchQuery || searchStatus!=='idle'&&searchStatus!=='complete'} className="bg-indigo-600 text-white px-4 rounded-lg text-sm flex items-center gap-2 hover:bg-indigo-700 disabled:bg-slate-300">
                                            {searchStatus!=='idle'&&searchStatus!=='complete' ? <Icons.Loader2 className="animate-spin" size={16}/> : <Icons.Search size={16}/>} ÂàÜÊûê
                                        </button>
                                    </div>
                                    {errorMsg && (
                                        <div className="text-xs text-red-500 p-2 bg-red-50 rounded border border-red-100">
                                            <div className="flex items-center gap-1 font-bold mb-1"><Icons.AlertCircle size={12}/> ÈåØË™§Ôºö{errorMsg}</div>
                                            {rawAiResponse && (
                                                <details className="mt-1">
                                                    <summary className="cursor-pointer text-red-400">Êü•ÁúãÂéüÂßãÂõûÊáâ (Èô§ÈåØÁî®)</summary>
                                                    <pre className="mt-2 p-2 bg-slate-800 text-white rounded overflow-x-auto text-[10px] whitespace-pre-wrap">
                                                        {rawAiResponse}
                                                    </pre>
                                                </details>
                                            )}
                                        </div>
                                    )}
                                    {searchStatus!=='idle' && searchStatus!=='complete' && !errorMsg && (
                                        <div className="space-y-1">
                                            {searchLog.map((log,i)=><div key={i} className="text-xs text-slate-600 flex items-center gap-1 animate-fadeIn"><Icons.CheckCircle2 size={10} className="text-green-500"/>{log}</div>)}
                                        </div>
                                    )}
                                </div>
                                {searchStatus==='complete' && (
                                    <div className="animate-fadeIn space-y-6">
                                        <div className="bg-white border border-slate-200 rounded-xl p-4 shadow-sm">
                                            <h3 className="text-sm font-bold text-slate-800 mb-3 flex gap-2"><Icons.Shield size={16} className="text-blue-600"/> SWOT ÂàÜÊûê</h3>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                <div className="p-2 bg-green-50 border-l-2 border-green-500 rounded"><div className="text-xs font-bold text-green-700 mb-1">Strengths</div><ul className="list-disc pl-3 text-[10px] text-slate-600">{swot.strengths.map((s,i)=><li key={i}>{s}</li>)}</ul></div>
                                                <div className="p-2 bg-red-50 border-l-2 border-red-500 rounded"><div className="text-xs font-bold text-red-700 mb-1">Weaknesses</div><ul className="list-disc pl-3 text-[10px] text-slate-600">{swot.weaknesses.map((s,i)=><li key={i}>{s}</li>)}</ul></div>
                                                <div className="p-2 bg-blue-50 border-l-2 border-blue-500 rounded"><div className="text-xs font-bold text-blue-700 mb-1">Opportunities</div><ul className="list-disc pl-3 text-[10px] text-slate-600">{swot.opportunities.map((s,i)=><li key={i}>{s}</li>)}</ul></div>
                                                <div className="p-2 bg-yellow-50 border-l-2 border-yellow-500 rounded"><div className="text-xs font-bold text-yellow-700 mb-1">Threats</div><ul className="list-disc pl-3 text-[10px] text-slate-600">{swot.threats.map((s,i)=><li key={i}>{s}</li>)}</ul></div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        );
                    case 'positioning':
                        return (
                            <div className="space-y-6 animate-fadeIn pb-20 md:pb-0">
                                <SectionTitle icon={Icons.Target} title="ÂìÅÁâåÂÆö‰Ωç" subtitle="Ê†∏ÂøÉÂÉπÂÄºËàáÂ±¨ÊÄß" />
                                <div className="space-y-4">
                                    <div><label className="text-xs text-slate-500">ÂìÅÁâåÂêçÁ®±</label><input className="w-full border p-2 rounded" value={data.brandName} onChange={(e)=>setData({...data, brandName:e.target.value})} /></div>
                                    <div><label className="text-xs text-slate-500">È°òÊôØ</label><textarea className="w-full border p-2 rounded" rows="2" value={data.positioning.vision} onChange={(e)=>handleNestedChange('positioning','vision',e.target.value)} /></div>
                                    <div className="h-64 w-full border rounded p-2 bg-white">
                                        <SafeChart type="RadarChart" cx="50%" cy="50%" outerRadius="80%" data={data.positioning.attributes} />
                                    </div>
                                </div>
                            </div>
                        );
                    case 'competitors':
                        return (
                            <div className="space-y-6 animate-fadeIn pb-20 md:pb-0">
                                <SectionTitle icon={Icons.BarChart2} title="Á´∂ÂìÅÂàÜÊûê" subtitle="ÂÆö‰ΩçÂú∞ÂúñËàáÊï∏Êìö" />
                                <div className="w-full h-80 bg-white border rounded-xl p-4">
                                    <SafeChart type="ScatterChart" />
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-xs text-left">
                                        <thead className="bg-slate-100"><tr><th className="p-2">ÂìÅÁâå</th><th className="p-2">È°ûÂà•</th><th className="p-2">ÂÉπÊ†º</th><th className="p-2">ÂìÅË≥™</th><th className="p-2">ÁÜ±Â∫¶</th></tr></thead>
                                        <tbody>
                                            {data.competitors.map((c,i)=>(
                                                <tr key={i} className="border-b"><td className="p-2 font-bold">{c.name}</td><td className="p-2 text-slate-500">{c.type || '-'}</td><td className="p-2">{getScoreLabel(c.price,'price')}</td><td className="p-2">{getScoreLabel(c.quality,'quality')}</td><td className="p-2 text-red-500">{getScoreLabel(c.brandHeat,'brandHeat')}</td></tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        );
                    case 'audience':
                        return (
                            <div className="space-y-6 animate-fadeIn pb-20 md:pb-0">
                                <SectionTitle icon={Icons.Users} title="ÁõÆÊ®ôÂÆ¢Áæ§" subtitle="AI Ëá™ÂãïÁîüÊàêËàáÁ∑®ËºØ" />
                                <div className="grid grid-cols-1 gap-4">
                                    {data.targetAudience.map((ta, idx) => (
                                        <div key={idx} className="bg-slate-50 p-3 rounded border border-slate-200">
                                            <input className="w-full bg-white border border-slate-300 rounded p-2 text-sm mb-2 font-bold" value={ta.name} onChange={(e) => {
                                                const newAudience = [...data.targetAudience];
                                                newAudience[idx].name = e.target.value;
                                                setData({...data, targetAudience: newAudience});
                                            }} />
                                            <input className="w-full bg-white border border-slate-300 rounded p-2 text-xs mb-2" value={ta.age} onChange={(e) => {
                                                const newAudience = [...data.targetAudience];
                                                newAudience[idx].age = e.target.value;
                                                setData({...data, targetAudience: newAudience});
                                            }} />
                                             <textarea className="w-full bg-white border border-slate-300 rounded p-2 text-xs" rows="2" value={ta.painPoint} onChange={(e) => {
                                                const newAudience = [...data.targetAudience];
                                                newAudience[idx].painPoint = e.target.value;
                                                setData({...data, targetAudience: newAudience});
                                            }} />
                                        </div>
                                    ))}
                                </div>
                            </div>
                        );
                    case 'businessModel':
                        return (
                            <div className="space-y-6 animate-fadeIn pb-20 md:pb-0">
                                <SectionTitle icon={Icons.Layout} title="ÂïÜÊ•≠Ê®°ÂºèÁï´Â∏É" subtitle="AI Ëá™ÂãïÁîüÊàêËàáÁ∑®ËºØ" />
                                <div className="grid grid-cols-1 gap-4">
                                    {Object.entries(data.businessModel).map(([key, val]) => (
                                        <div key={key} className="bg-slate-50 p-3 rounded border border-slate-200">
                                            <label className="block text-xs font-bold text-slate-500 uppercase mb-2">{BMC_TITLES[key] || key}</label>
                                            <textarea className="w-full bg-white border border-slate-300 rounded p-2 text-sm" rows="2" value={val.join(', ')} onChange={(e) => {
                                                const newVal = e.target.value.split(',').map(s => s.trim());
                                                setData({...data, businessModel: {...data.businessModel, [key]: newVal}});
                                            }} />
                                        </div>
                                    ))}
                                </div>
                            </div>
                        );
                    default: return <div className="p-4 text-slate-400">Ë´ãÈÅ∏ÊìáÂäüËÉΩÊ®°ÁµÑ</div>;
                }
            };

            const renderPreview = () => {
                const { swot } = data.intelligence;
                switch (activeTab) {
                    case 'intelligence':
                        return (
                            <div className="h-full p-6 overflow-y-auto custom-scrollbar pb-20 md:pb-6">
                                <h2 className="text-2xl font-bold mb-4 text-slate-800">{data.brandName || 'ÂìÅÁâåÂêçÁ®±'}</h2>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                    <div className="bg-green-50 p-3 rounded border-l-4 border-green-500"><h4 className="font-bold text-green-700 text-sm mb-2">Strengths</h4><ul className="list-disc pl-4 text-xs text-slate-600 space-y-1">{swot.strengths.map((s,i)=><li key={i}>{s}</li>)}</ul></div>
                                    <div className="bg-red-50 p-3 rounded border-l-4 border-red-500"><h4 className="font-bold text-red-700 text-sm mb-2">Weaknesses</h4><ul className="list-disc pl-4 text-xs text-slate-600 space-y-1">{swot.weaknesses.map((s,i)=><li key={i}>{s}</li>)}</ul></div>
                                    <div className="bg-blue-50 p-3 rounded border-l-4 border-blue-500"><h4 className="font-bold text-blue-700 text-sm mb-2">Opportunities</h4><ul className="list-disc pl-4 text-xs text-slate-600 space-y-1">{swot.opportunities.map((s,i)=><li key={i}>{s}</li>)}</ul></div>
                                    <div className="bg-yellow-50 p-3 rounded border-l-4 border-yellow-500"><h4 className="font-bold text-yellow-700 text-sm mb-2">Threats</h4><ul className="list-disc pl-4 text-xs text-slate-600 space-y-1">{swot.threats.map((s,i)=><li key={i}>{s}</li>)}</ul></div>
                                </div>
                                <div className="h-64 bg-white rounded-xl border p-4 mb-4">
                                    <h4 className="text-sm font-bold mb-2 text-slate-600 flex items-center gap-2"><Icons.TrendingUp size={16}/> ÊêúÂ∞ãË∂®Âã¢</h4>
                                    <SafeChart type="AreaChart" data={data.intelligence.monthlySearchVolume.map((v, i) => ({ name: data.intelligence.trendLabels[i], value: v }))} />
                                </div>
                            </div>
                        );
                    case 'competitors':
                         return (
                            <div className="h-full p-6 flex flex-col items-center overflow-y-auto custom-scrollbar pb-20 md:pb-6">
                                <h2 className="text-2xl font-bold mb-4">Á´∂ÂìÅÂÆö‰ΩçÂú∞Âúñ</h2>
                                <div className="w-full h-[400px] md:h-[500px] bg-white border rounded-xl p-4 mb-6 relative">
                                     <div className="absolute top-2 right-2 z-10 flex flex-col gap-1 bg-white/80 p-2 rounded text-[10px]">
                                        <div className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-green-500"></span> Êú¨ÂìÅÁâå</div>
                                        <div className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-blue-500"></span> ÂêåÈ°ûÂûã</div>
                                        <div className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-purple-500"></span> ÂêåÂúãÂÆ∂</div>
                                        <div className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-orange-500"></span> ÂêåÈ¢®Ê†º</div>
                                    </div>
                                    <SafeChart type="ScatterChart" />
                                </div>
                                <div className="w-full overflow-x-auto">
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-slate-100"><tr><th className="p-3 whitespace-nowrap">ÂìÅÁâå</th><th className="p-3 whitespace-nowrap">È°ûÂà•</th><th className="p-3 whitespace-nowrap">ÂÉπÊ†ºÂÆö‰Ωç</th><th className="p-3 whitespace-nowrap">ÂìÅË≥™Â±§Á¥ö</th><th className="p-3 whitespace-nowrap">ÁÜ±Â∫¶</th></tr></thead>
                                        <tbody>{data.competitors.map((c,i)=><tr key={i} className="border-b"><td className="p-3 font-bold whitespace-nowrap">{c.name}</td><td className="p-3 text-slate-500 whitespace-nowrap">{c.type}</td><td className="p-3 text-slate-600">{getScoreLabel(c.price,'price')}</td><td className="p-3 text-slate-600">{getScoreLabel(c.quality,'quality')}</td><td className="p-3 text-red-500 font-bold">{getScoreLabel(c.brandHeat,'brandHeat')}</td></tr>)}</tbody>
                                    </table>
                                </div>
                            </div>
                         );
                    case 'positioning':
                        return (
                            <div className="h-full p-6 overflow-y-auto custom-scrollbar pb-20 md:pb-6 flex flex-col items-center">
                                <div className="w-full h-80 md:h-96"><SafeChart type="RadarChart" cx="50%" cy="50%" outerRadius="80%" data={data.positioning.attributes} /></div>
                                <div className="mt-6 grid grid-cols-1 gap-4 w-full">
                                    <div className="p-4 bg-indigo-50 rounded-lg"><h4 className="font-bold text-indigo-800 mb-2">È°òÊôØ</h4><p className="text-sm text-slate-700">{data.positioning.vision}</p></div>
                                    <div className="p-4 bg-purple-50 rounded-lg"><h4 className="font-bold text-purple-800 mb-2">‰ΩøÂëΩ</h4><p className="text-sm text-slate-700">{data.positioning.mission}</p></div>
                                </div>
                            </div>
                        );
                    case 'audience':
                        return (
                            <div className="h-full p-6 overflow-y-auto custom-scrollbar pb-20 md:pb-6">
                                <h2 className="text-2xl font-bold mb-4 text-slate-800">ÁõÆÊ®ôÂÆ¢Áæ§ (TA)</h2>
                                {data.targetAudience.length === 0 ? (
                                    <div className="text-center p-8 text-slate-400 bg-slate-50 rounded border border-dashed">Â∞öÁÑ°ÂÆ¢Áæ§Ë≥áÊñô</div>
                                ) : (
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        {data.targetAudience.map((ta, idx) => (
                                            <div key={idx} className="bg-white border rounded-xl p-4 shadow-sm">
                                                <div className="flex items-center gap-3 mb-3">
                                                    <div className="bg-blue-100 p-2 rounded-full text-blue-600"><Icons.Users size={20}/></div>
                                                    <div><div className="font-bold text-lg">{ta.name}</div><div className="text-xs text-slate-500">{ta.age}</div></div>
                                                </div>
                                                <div className="space-y-2 text-xs">
                                                    <div className="p-2 bg-slate-50 rounded"><strong>Êî∂ÂÖ•:</strong> {ta.income}</div>
                                                    <div className="p-2 bg-slate-50 rounded"><strong>ÁóõÈªû:</strong> {ta.painPoint}</div>
                                                    <div className="p-2 bg-slate-50 rounded"><strong>ËààË∂£:</strong> {ta.hobby}</div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        );
                    case 'businessModel':
                         return (
                            <div className="h-full p-6 overflow-y-auto custom-scrollbar pb-20 md:pb-6">
                                <h2 className="text-2xl font-bold mb-4">ÂïÜÊ•≠Ê®°ÂºèÁï´Â∏É</h2>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    {Object.entries(data.businessModel).map(([k,v], i)=>(
                                        <div key={i} className="bg-white border p-3 rounded shadow-sm">
                                            <h4 className="text-xs font-bold uppercase text-slate-500 mb-2">{BMC_TITLES[k] || k}</h4>
                                            <ul className="list-disc pl-4 text-xs space-y-1">{v.map((item,j)=><li key={j}>{item}</li>)}</ul>
                                        </div>
                                    ))}
                                </div>
                            </div>
                         );
                    default: return <div className="p-10 text-center text-slate-400">Ë´ãÈÅ∏ÊìáÂäüËÉΩ</div>;
                }
            }

            return (
                <div id="pdf-export-target" className="min-h-screen bg-slate-50 flex flex-col font-sans h-full fixed w-full">
                    {/* Header: Mobile Êúâ ToggleÔºåDesktop Âè™Êúâ Title */}
                    <header className="bg-white border-b h-14 px-4 flex items-center justify-between shrink-0 z-20">
                        <div className="flex items-center gap-2"><div className="bg-blue-600 p-1.5 rounded"><Icons.Zap className="text-white" size={18}/></div><h1 className="font-bold text-md md:text-lg">Krang</h1></div>
                        
                        {/* Mobile Toggle Switch */}
                        <div className="flex md:hidden bg-slate-100 rounded-lg p-1">
                            <button onClick={()=>setIsPresentationMode(false)} className={`px-3 py-1 text-xs rounded-md transition-all ${!isPresentationMode?'bg-white shadow text-blue-600 font-bold':'text-slate-500'}`}>Á∑®ËºØ</button>
                            <button onClick={()=>setIsPresentationMode(true)} className={`px-3 py-1 text-xs rounded-md transition-all ${isPresentationMode?'bg-white shadow text-blue-600 font-bold':'text-slate-500'}`}>È†êË¶Ω</button>
                        </div>

                        {/* Desktop Actions */}
                        <div className="hidden md:flex gap-2">
                             <button id="download-btn" onClick={handleDownloadPDF} className="flex items-center gap-2 px-3 py-1.5 bg-red-600 text-white rounded hover:bg-red-700 text-sm shadow-sm"><Icons.Save size={16}/> ‰∏ãËºâ PDF</button>
                            <button onClick={()=>setIsPresentationMode(true)} className="flex items-center gap-2 px-3 py-1.5 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm"><Icons.Presentation size={16}/> Á∞°Â†±Ê®°Âºè</button>
                        </div>
                    </header>

                    {/* Main Content */}
                    <div className="flex flex-1 overflow-hidden relative">
                        {/* Desktop Sidebar / Mobile Bottom Nav */}
                        <nav className="hidden md:flex w-64 bg-white border-r flex-col overflow-y-auto p-4 space-y-1 shrink-0">
                            {navItems.map(item => <button key={item.id} onClick={()=>setActiveTab(item.id)} className={`w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg transition-all ${activeTab===item.id?'bg-blue-50 text-blue-600 shadow-sm':'text-slate-500 hover:bg-slate-50'}`}><item.icon size={18}/>{item.label}</button>)}
                        </nav>

                        {/* Mobile Bottom Navigation */}
                        {!isPresentationMode && (
                            <div className="md:hidden fixed bottom-0 w-full bg-white border-t flex justify-around py-2 z-30">
                                {navItems.map(item => (
                                    <button key={item.id} onClick={()=>setActiveTab(item.id)} className={`flex flex-col items-center p-1 ${activeTab===item.id?'text-blue-600':'text-slate-400'}`}>
                                        <item.icon size={20} />
                                        <span className="text-[10px] mt-1">{item.label.slice(0,2)}</span>
                                    </button>
                                ))}
                            </div>
                        )}

                        <main className="flex-1 flex flex-col md:flex-row overflow-hidden relative pb-16 md:pb-0">
                            {/* Editor Pane (ÊâãÊ©üÁâàÂú®Á∞°Â†±Ê®°Âºè‰∏ãÈö±Ëóè) */}
                            <div className={`flex-1 p-4 md:p-8 overflow-y-auto bg-slate-50/50 border-r ${isPresentationMode ? 'hidden md:block' : 'block'}`}>
                                <div className="max-w-xl mx-auto">{renderEditor()}</div>
                            </div>

                            {/* Desktop Preview Pane (ÊâãÊ©üÁâàÈö±ËóèÔºåÂè™Âú® Modal È°ØÁ§∫) */}
                            <div className="hidden md:block flex-1 bg-white p-8 overflow-y-auto relative">
                                <div className="h-full border-2 border-dashed border-slate-100 rounded-xl flex flex-col overflow-hidden relative">
                                    <div className="absolute top-4 right-4 text-[10px] font-bold text-slate-300 uppercase z-10">Live Dashboard</div>
                                    {renderPreview()}
                                </div>
                            </div>
                            
                            {/* Mobile Preview Mode (ÂÖ®Ëû¢ÂπïË¶ÜËìã) */}
                             {isPresentationMode && (
                                <div className="md:hidden absolute inset-0 bg-white z-20 overflow-y-auto">
                                    {renderPreview()}
                                </div>
                            )}
                        </main>
                    </div>

                    {/* Desktop Fullscreen Presentation Modal */}
                    {isPresentationMode && (
                        <div className="hidden md:flex fixed inset-0 z-50 bg-slate-900 flex-col text-white">
                            <div className="flex justify-between items-center p-4 border-b border-slate-700">
                                <div className="flex items-center gap-2"><span className="font-mono text-sm text-slate-400">BRAND INTELLIGENCE DECK</span></div>
                                <button onClick={()=>setIsPresentationMode(false)} className="bg-white text-slate-900 px-4 py-2 rounded font-bold hover:bg-slate-200">ÈÄÄÂá∫</button>
                            </div>
                            <div className="flex-1 p-8 flex justify-center overflow-auto bg-slate-100 text-slate-900">
                                <div className="w-full max-w-5xl bg-white rounded-2xl shadow-2xl overflow-hidden">{renderPreview()}</div>
                            </div>
                            <div className="p-4 bg-slate-800 flex justify-center gap-4">
                                {navItems.map(item => <button key={item.id} onClick={()=>setActiveTab(item.id)} className={`px-4 py-2 rounded text-sm ${activeTab===item.id?'bg-blue-600':'hover:bg-slate-700'}`}>{item.label}</button>)}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // React 17 ‰ΩøÁî® ReactDOM.render
        ReactDOM.render(<BrandStrategyApp />, document.getElementById('root'));
    </script>
</body>
</html>
