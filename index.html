<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Brand Strategy Deck Generator</title>
    
    <!-- 1. ç’°å¢ƒè®Šæ•¸ -->
    <script>
        window.process = { env: { NODE_ENV: 'production' } };
    </script>

    <!-- 2. æ ¸å¿ƒ React åº« (ä½¿ç”¨ React 17 ç©©å®šç‰ˆ) -->
    <script crossorigin src="https://unpkg.com/react@17.0.2/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17.0.2/umd/react-dom.production.min.js"></script>
    
    <!-- 3. é—œéµè£œä¸ -->
    <script>
        if (window.React && !window.React.default) {
            window.React.default = window.React;
        }
        if (window.ReactDOM && !window.ReactDOM.default) {
            window.ReactDOM.default = window.ReactDOM;
        }
    </script>

    <!-- 4. Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    
    <!-- 5. æ¨£å¼åº« -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 6. Recharts ä¾è³´ & ä¸»ç¨‹å¼ (ä½¿ç”¨ 1.8.5 ç©©å®šç‰ˆ) -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@1.8.5/umd/Recharts.min.js"></script>
    
    <!-- 7. PDF ç”Ÿæˆåº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- 8. éŒ¯èª¤æŠ‘åˆ¶ -->
    <script>
        const originalError = console.error;
        console.error = function(...args) {
            const msg = args[0];
            if (typeof msg === 'string' && (
                msg.includes('defaultProps') || 
                msg.includes('validateDOMNesting') ||
                msg.includes('Support for defaultProps') ||
                msg.includes('componentWillReceiveProps')
            )) return;
            originalError.apply(console, args);
        };
    </script>

    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.5s ease-out forwards; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* PDF æ¨¡å¼æ¨£å¼ */
        .pdf-section {
            background: white;
            padding: 40px;
            width: 100%;
            max-width: 800px;
            margin: 0 auto 20px auto;
            page-break-after: always;
            min-height: 600px;
            position: relative;
        }
        .pdf-mode {
            overflow: hidden;
            height: 100vh;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans antialiased">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Icons ---
        const Icons = {
            Globe: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg>,
            Target: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>,
            Users: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            BarChart2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="18" x2="18" y1="20" y2="10"/><line x1="12" x2="12" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="14"/></svg>,
            Layout: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><line x1="3" x2="21" y1="9" y2="9"/><line x1="9" x2="9" y1="21" y2="9"/></svg>,
            Zap: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
            Save: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            Presentation: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M2 3h20"/><path d="M21 3v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V3"/><path d="m7 21 5-5 5 5"/></svg>,
            Sparkles: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M2 7h4"/><path d="M2 17h4"/><path d="M5 17v4"/><path d="M9 17v4"/></svg>,
            Key: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="7.5" cy="15.5" r="5.5"/><path d="m21 2-9.6 9.6"/><path d="m15.5 7.5 3 3L22 7l-3-3"/></svg>,
            Loader2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
            Search: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/></svg>,
            AlertCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
            CheckCircle2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>,
            Shield: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>,
            TrendingUp: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
            TrendingDown: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></svg>,
            AlertTriangle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>,
            Flame: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg>,
            Newspaper: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2"/><path d="M18 14h-8"/><path d="M15 18h-5"/><path d="M10 6h8"/></svg>,
            Briefcase: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>,
            Plus: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></svg>,
            Trash2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Crosshair: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><line x1="22" x2="18" y1="12" y2="12"/><line x1="6" x2="2" y1="12" y2="12"/><line x1="12" x2="12" y1="6" y2="2"/><line x1="12" x2="12" y1="22" y2="18"/></svg>,
            Info: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12.01" y1="8" y2="8"/></svg>,
            Lock: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            Brain: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M9.5 2A2.5 12.1 0 1 1 14.5 2"/><path d="M12 2v4"/><path d="M9 7a5 5 0 1 0 6 0"/><path d="M5 11a6.8 6.8 0 0 0 .7 2.7"/><path d="M18.3 13.7A6.8 6.8 0 0 0 19 11"/><path d="M3 11a14.6 14.6 0 0 1 1-4"/><path d="M20 7a14.6 14.6 0 0 1 1 4"/><path d="M6.8 16.5A8.9 8.9 0 0 1 2 18"/><path d="M22 18a8.9 8.9 0 0 1-4.8-1.5"/><path d="M6 22v-2a5.2 5.2 0 0 1 2.5-4.5"/><path d="M18 22v-2a5.2 5.2 0 0 0-2.5-4.5"/></svg>
        };

        // API Key
        const apiKey = ""; 

        const getLast6MonthsLabels = () => {
            const labels = [];
            for (let i = 5; i >= 0; i--) {
                const d = new Date();
                d.setMonth(d.getMonth() - i);
                const monthStr = `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(2, '0')}`;
                labels.push(monthStr);
            }
            return labels;
        };

        const getScoreLabel = (score, type) => {
            const s = Number(score);
            if (type === 'price') {
                if (s < 40) return 'è¦ªæ°‘å¹³åƒ¹';
                if (s < 75) return 'ä¸­åƒ¹ä½';
                return 'é«˜å–®åƒ¹';
            }
            if (type === 'quality') {
                if (s < 40) return 'åŸºç¤/å¤§çœ¾';
                if (s < 75) return 'è³ªæ„Ÿ/æµè¡Œ';
                return 'å‰è¡›/è¨­è¨ˆå¸«';
            }
            if (type === 'brandHeat') {
                if (s < 40) return 'æ½›åŠ›å°çœ¾';
                if (s < 75) return 'å…·çŸ¥ååº¦';
                return 'å¸‚å ´ç†±é–€';
            }
            return s;
        };

        const getTypeColor = (type) => {
            switch(type) {
                case 'æœ¬å“ç‰Œ': return '#22c55e'; 
                case 'åŒé¡å‹': return '#3b82f6'; 
                case 'åŒåœ‹å®¶': return '#a855f7'; 
                case 'åŒé¢¨æ ¼': return '#f97316'; 
                default: return '#8884d8'; 
            }
        };

        const BMC_TITLES = {
            partners: 'é—œéµåˆä½œå¤¥ä¼´ (Key Partners)',
            activities: 'é—œéµæ´»å‹• (Key Activities)',
            resources: 'é—œéµè³‡æº (Key Resources)',
            valueProp: 'åƒ¹å€¼ä¸»å¼µ (Value Propositions)',
            relationships: 'é¡§å®¢é—œä¿‚ (Customer Relationships)',
            channels: 'é€šè·¯ (Channels)',
            segments: 'ç›®æ¨™å®¢ç¾¤ (Customer Segments)',
            costStructure: 'æˆæœ¬çµæ§‹ (Cost Structure)',
            revenueStreams: 'æ”¶ç›Šæµ (Revenue Streams)'
        };

        const initialData = {
            brandName: "",
            searchQuery: "",
            marketScope: "local",
            intelligence: {
                sentiment: { positive: 0, neutral: 0, negative: 0 },
                keywords: [],
                summary: "å°šæœªé€²è¡Œåˆ†æ...",
                monthlySearchVolume: [0, 0, 0, 0, 0, 0],
                trendLabels: getLast6MonthsLabels(),
                competitorNews: [],
                swot: { strengths: [], weaknesses: [], opportunities: [], threats: [] }
            },
            positioning: {
                vision: "", mission: "", values: "",
                attributes: [
                    { subject: 'åƒ¹æ ¼è¦ªæ°‘', A: 50, fullMark: 100 },
                    { subject: 'å“è³ªé«˜ç«¯', A: 50, fullMark: 100 },
                    { subject: 'ç’°å¢ƒèˆ’é©', A: 50, fullMark: 100 },
                    { subject: 'å“ç‰Œç†±åº¦', A: 50, fullMark: 100 },
                    { subject: 'å‰µæ–°ç¨‹åº¦', A: 50, fullMark: 100 },
                    { subject: 'å“ç‰ŒçŸ¥ååº¦', A: 50, fullMark: 100 },
                ]
            },
            targetAudience: [
                { id: 1, name: "å¾…åˆ†æå®¢ç¾¤ A", age: "??-??", income: "???", painPoint: "ç­‰å¾… AI åˆ†æ...", hobby: "???" },
            ],
            competitors: [ { name: "è‡ªå®¶å“ç‰Œ", type: "æœ¬å“ç‰Œ", price: 50, quality: 50, brandHeat: 50, feature: "å°šæœªåˆ†æ" } ],
            businessModel: {
                partners: [], activities: [], resources: [], valueProp: [],
                relationships: [], channels: [], segments: [], costStructure: [], revenueStreams: []
            }
        };

        const Card = ({ children, className = "" }) => <div className={`bg-white rounded-xl shadow-sm border border-slate-200 p-6 ${className}`}>{children}</div>;

        const SectionTitle = ({ icon: IconComp, title, subtitle }) => (
            <div className="mb-6">
                <div className="flex items-center gap-2 text-blue-600 mb-1">
                    {IconComp && <IconComp size={24} />}
                    <h2 className="text-xl font-bold">{title}</h2>
                </div>
                <p className="text-slate-500 text-sm">{subtitle}</p>
            </div>
        );

        function BrandStrategyApp() {
            const [activeTab, setActiveTab] = useState('intelligence');
            const [isPresentationMode, setIsPresentationMode] = useState(false);
            const [data, setData] = useState(initialData);
            const [customApiKey, setCustomApiKey] = useState('');
            
            const [searchStatus, setSearchStatus] = useState('idle');
            const [searchLog, setSearchLog] = useState([]);
            const [errorMsg, setErrorMsg] = useState(null);
            const [rawAiResponse, setRawAiResponse] = useState('');
            const [isRechartsLoaded, setIsRechartsLoaded] = useState(false);
            const [isGeneratingPDF, setIsGeneratingPDF] = useState(false);

            useEffect(() => {
                const checkRecharts = () => {
                    if (window.Recharts) {
                        setIsRechartsLoaded(true);
                    } else {
                        setTimeout(checkRecharts, 300);
                    }
                };
                checkRecharts();
            }, []);

            const navItems = [
                { id: 'intelligence', label: 'æ·±åº¦æƒ…è³‡èˆ‡ SWOT', icon: Icons.Globe },
                { id: 'positioning', label: 'å“ç‰Œå®šä½ (Positioning)', icon: Icons.Target },
                { id: 'audience', label: 'ç›®æ¨™å®¢ç¾¤ (TA)', icon: Icons.Users },
                { id: 'competitors', label: 'ç«¶å“åˆ†æ (Competitors)', icon: Icons.BarChart2 },
                { id: 'businessModel', label: 'å•†æ¥­æ¨¡å¼ (BMC)', icon: Icons.Layout },
            ];

            // å¼·å¥çš„ JSON è§£æå™¨ v6 (é‡å°é™£åˆ—èˆ‡ç‰©ä»¶é€—è™Ÿéºæ¼çš„å…¨é¢ä¿®å¾©)
            const parseJSON = (text) => {
                if (!text) throw new Error("AI æœªå›å‚³ä»»ä½•å…§å®¹");

                let cleaned = text.trim();
                // ç§»é™¤ Markdown æ¨™è¨˜
                cleaned = cleaned.replace(/^```json\s*/i, '').replace(/^```\s*/i, '').replace(/```$/i, '');
                
                // å°‹æ‰¾æ‹¬è™Ÿ
                const firstBrace = cleaned.indexOf('{');
                const lastBrace = cleaned.lastIndexOf('}');
                
                if (firstBrace !== -1 && lastBrace !== -1) {
                    cleaned = cleaned.substring(firstBrace, lastBrace + 1);
                } else {
                    throw new Error("ç„¡æ³•è­˜åˆ¥ JSON çµæ§‹");
                }

                // 1. ä¿®å¾©å°¾éš¨é€—è™Ÿ
                let fixed = cleaned.replace(/,(\s*[\]}])/g, '$1');
                
                // 2. ä¿®å¾©å­—ä¸²é™£åˆ—æ¼æ‰é€—è™Ÿ (ä¾‹å¦‚ "A" "B")
                fixed = fixed.replace(/"\s+(?=")/g, '", ');
                
                // 3. ä¿®å¾©ç‰©ä»¶é™£åˆ—æ¼æ‰é€—è™Ÿ (} { -> }, {)
                fixed = fixed.replace(/}\s*{/g, '}, {');
                
                // 4. ä¿®å¾©é™£åˆ—çµæŸå¾Œæ¥çºŒå­—ä¸² (] "key" -> ], "key")
                fixed = fixed.replace(/]\s*"/g, '], "');

                try {
                    return JSON.parse(fixed);
                } catch (e) {
                    try {
                        // å‚™ç”¨ï¼šå¦‚æœä¿®å¾©å¤±æ•—ï¼Œå˜—è©¦æœ€åŸå§‹çš„
                        return JSON.parse(cleaned);
                    } catch (e2) {
                        // é¡¯ç¤ºéƒ¨åˆ†éŒ¯èª¤è¨Šæ¯ä»¥ä¾›é™¤éŒ¯
                         throw new Error(`JSON æ ¼å¼éŒ¯èª¤: ${e2.message.slice(0, 50)}...`);
                    }
                }
            };

            const fetchGeminiAnalysis = async (query, scope) => {
                const validApiKey = apiKey || customApiKey;
                if (!validApiKey) throw new Error("è«‹è¼¸å…¥ Google API Key");

                const prompt = `
                Role: Senior Brand Strategist.
                Task: Analyze brand "${query}" in ${scope === 'local' ? 'Taiwan' : 'Global'} market.
                
                CRITICAL INSTRUCTION:
                - Return ONLY valid JSON.
                - Content in Traditional Chinese.
                - NO trailing commas.
                - **STRICTLY SEPARATE ARRAY ITEMS WITH COMMAS**. (e.g. ["A", "B"])
                - **STRICTLY SEPARATE OBJECTS WITH COMMAS**. (e.g. { ... }, { ... })
                
                REQUIRED SCORING LOGIC for Competitor Pricing:
                - Mass Market (e.g., Uniqlo, Zara): 10-35 points.
                - Mid-tier/Indie (e.g., Carhartt WIP): 40-65 points.
                - High-End Street/Designer (e.g., Supreme, WTAPS): 65-85 points.
                - Luxury/Select Shop (e.g., INVINCIBLE, Kith, Visvim): 85-100 points.
                * INVINCIBLE must be scored significantly higher (>80) than mid-tier brands.

                Required JSON Structure:
                {
                    "brandName": "${query}",
                    "intelligence": {
                        "sentiment": { "positive": 70, "neutral": 20, "negative": 10 },
                        "keywords": ["k1", "k2", "k3", "k4", "k5"],
                        "summary": "Summary...",
                        "competitorNews": [{ "source": "Source", "title": "Title", "date": "YYYY-MM-DD" }],
                        "swot": {
                            "strengths": ["S1", "S2", "S3"],
                            "weaknesses": ["W1", "W2", "W3"],
                            "opportunities": ["O1", "O2", "O3"],
                            "threats": ["T1", "T2", "T3"]
                        }
                    },
                    "positioning": {
                        "vision": "Vision", "mission": "Mission", "values": "Values",
                        "attributes": [
                            { "subject": "åƒ¹æ ¼è¦ªæ°‘", "A": 50, "fullMark": 100 },
                            { "subject": "å“è³ªé«˜ç«¯", "A": 80, "fullMark": 100 },
                            { "subject": "ç’°å¢ƒèˆ’é©", "A": 70, "fullMark": 100 },
                            { "subject": "å“ç‰Œç†±åº¦", "A": 60, "fullMark": 100 },
                            { "subject": "å‰µæ–°ç¨‹åº¦", "A": 60, "fullMark": 100 },
                            { "subject": "å“ç‰ŒçŸ¥ååº¦", "A": 80, "fullMark": 100 }
                        ]
                    },
                    "competitors": [
                        { "name": "Competitor A", "type": "åŒé¡å‹", "feature": "Feature", "price": 80, "quality": 70, "brandHeat": 90 }
                    ],
                    "targetAudience": [
                        { "id": 1, "name": "Persona", "age": "25-30æ­²", "income": "4-5è¬", "painPoint": "Pain", "hobby": "Hobby" }
                    ],
                    "businessModel": {
                        "partners": ["P1"], "activities": ["A1"], "resources": ["R1"], "valueProp": ["V1"],
                        "relationships": ["Rel1"], "channels": ["Ch1"], "segments": ["Seg1"],
                        "costStructure": ["C1"], "revenueStreams": ["Rev1"]
                    }
                }

                Requirements:
                1. Find at least 8 competitors.
                2. **Provide 3 to 6 detailed Personas** in "targetAudience" array.
                3. Fill all 9 blocks of BMC.
                `;

                try {
                    let attempt = 0;
                    const maxRetries = 2;
                    while (attempt < maxRetries) {
                        try {
                            const response = await fetch(
                                `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${validApiKey}`,
                                {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        contents: [{ parts: [{ text: prompt }] }],
                                        tools: [{ google_search: {} }]
                                    })
                                }
                            );

                            if (response.status !== 200) {
                                const errText = await response.text();
                                throw new Error(`API Error (${response.status}): ${errText}`);
                            }

                            const result = await response.json();
                            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                            
                            if (!text) throw new Error("No content generated from AI");
                            setRawAiResponse(text); 

                            return parseJSON(text);
                        } catch (e) {
                            attempt++;
                            console.warn(`Attempt ${attempt} failed:`, e);
                            if (attempt >= maxRetries) throw e;
                            await new Promise(r => setTimeout(r, 1000));
                        }
                    }

                } catch (error) {
                    console.error("Fetch Error:", error);
                    throw error;
                }
            };

            const handleSearch = async () => {
                if (!data.searchQuery) return;
                setSearchStatus('searching');
                setSearchLog([]);
                setErrorMsg(null);
                setRawAiResponse('');
                
                try {
                    setSearchLog(prev => [...prev, `ğŸ” æ·±åº¦æœå°‹ "${data.searchQuery}" ...`]);
                    const result = await fetchGeminiAnalysis(data.searchQuery, data.marketScope);
                    
                    setSearchLog(prev => [...prev, "ğŸ§  é€²è¡Œ SWOT èˆ‡ç«¶å“åˆ†æ..."]);
                    setSearchStatus('synthesizing');
                    await new Promise(r => setTimeout(r, 800));
                    setSearchLog(prev => [...prev, "âœ… åˆ†æå®Œæˆï¼"]);

                    const safeNumber = (v) => Number(v) || 50;
                    
                    const newCompetitors = (result.competitors || []).map(c => ({
                        name: c.name || "æœªçŸ¥å",
                        type: c.type || "æœªåˆ†é¡",
                        feature: c.feature || "",
                        price: safeNumber(c.price),
                        quality: safeNumber(c.quality),
                        brandHeat: safeNumber(c.brandHeat)
                    }));

                    const getAttr = (key) => {
                        if (!result.positioning || !result.positioning.attributes) return 50;
                        const found = result.positioning.attributes.find(a => a.subject && a.subject.includes(key));
                        return found ? safeNumber(found.A) : 50;
                    };
                    
                    newCompetitors.push({
                        name: result.brandName,
                        type: "æœ¬å“ç‰Œ",
                        feature: "æ‚¨çš„å“ç‰Œ",
                        price: getAttr('åƒ¹æ ¼'),
                        quality: getAttr('å“è³ª'),
                        brandHeat: getAttr('ç†±åº¦')
                    });

                    let newAudience = data.targetAudience;
                    if (Array.isArray(result.targetAudience)) {
                         newAudience = result.targetAudience.map((ta, index) => ({...ta, id: index + 1}));
                    } else if (Array.isArray(result.target_audience)) {
                         newAudience = result.target_audience.map((ta, index) => ({...ta, id: index + 1}));
                    }

                    const safeBMC = result.businessModel || data.businessModel;

                    setData(prev => ({
                        ...prev,
                        brandName: result.brandName,
                        intelligence: {
                            ...prev.intelligence,
                            ...result.intelligence,
                            monthlySearchVolume: Array.from({length: 6}, () => Math.floor(Math.random() * 60) + 40),
                            trendLabels: getLast6MonthsLabels(),
                            swot: {
                                strengths: result.intelligence?.swot?.strengths || ["ç„¡è³‡æ–™"],
                                weaknesses: result.intelligence?.swot?.weaknesses || ["ç„¡è³‡æ–™"],
                                opportunities: result.intelligence?.swot?.opportunities || ["ç„¡è³‡æ–™"],
                                threats: result.intelligence?.swot?.threats || ["ç„¡è³‡æ–™"]
                            }
                        },
                        positioning: result.positioning || prev.positioning,
                        competitors: newCompetitors,
                        targetAudience: newAudience,
                        businessModel: safeBMC
                    }));
                    setSearchStatus('complete');
                } catch (err) {
                    setErrorMsg(err.message);
                    setSearchStatus('idle');
                }
            };

            const handleDownloadPDF = async () => {
                setIsGeneratingPDF(true);
                const btn = document.getElementById('download-btn');
                const originalText = btn.innerText;
                btn.innerText = 'ç”Ÿæˆä¸­...';
                btn.disabled = true;

                await new Promise(resolve => setTimeout(resolve, 3000)); // å¢åŠ ç·©è¡æ™‚é–“åˆ°3ç§’ï¼Œç¢ºä¿æ¸²æŸ“

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('l', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();

                const sections = ['print-intelligence', 'print-positioning', 'print-audience', 'print-competitors', 'print-bmc'];

                try {
                    for (let i = 0; i < sections.length; i++) {
                        const sectionId = sections[i];
                        const element = document.getElementById(sectionId);
                        
                        // è‡ªå‹•æ»¾å‹•åˆ°è©²å…ƒç´ ï¼Œç¢ºä¿å¯è¦‹
                        if (element) {
                             // åœ¨æˆªåœ–å‰ç¢ºä¿å…ƒç´ å¯è¦‹ä¸”æ¨£å¼æ­£ç¢º
                            element.style.display = 'block';
                            
                            if (i > 0) pdf.addPage();
                            
                            // ç­‰å¾…ä¸€é»æ™‚é–“è®“ç€è¦½å™¨é‡ç¹ª
                            await new Promise(r => setTimeout(r, 500));

                            const canvas = await window.html2canvas(element, {
                                scale: 2,
                                useCORS: true, 
                                logging: false,
                                width: element.offsetWidth,
                                height: element.offsetHeight,
                                backgroundColor: '#ffffff', // å¼·åˆ¶ç™½åº•
                                windowWidth: 1200 // å¼·åˆ¶è¦–çª—å¯¬åº¦ï¼Œé¿å…RWDå°è‡´è·‘ç‰ˆ
                            });
                            
                            const imgData = canvas.toDataURL('image/png');
                            const imgProps = pdf.getImageProperties(imgData);
                            const ratio = Math.min((pdfWidth - 20) / imgProps.width, (pdfHeight - 20) / imgProps.height);
                            
                            const w = imgProps.width * ratio;
                            const h = imgProps.height * ratio;
                            const x = (pdfWidth - w) / 2;
                            const y = (pdfHeight - h) / 2;

                            pdf.addImage(imgData, 'PNG', x, y, w, h);
                        }
                    }
                    pdf.save(`${data.brandName || 'Brand_Strategy'}_Report.pdf`);
                } catch (err) {
                    console.error('PDF Export Error:', err);
                    alert('PDF ç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                } finally {
                    setIsGeneratingPDF(false);
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            };

            const handleNestedChange = (section, field, value) => {
                setData(prev => ({ ...prev, [section]: { ...prev[section], [field]: value } }));
            };

            const handleAttributeChange = (index, value) => {
                const newAttributes = [...data.positioning.attributes];
                newAttributes[index].A = Number(value);
                setData(prev => ({ ...prev, positioning: { ...prev.positioning, attributes: newAttributes } }));
            };

            // Recharts 1.8.5 å®‰å…¨æ¸²æŸ“çµ„ä»¶
            const SafeChart = ({ type, children, ...props }) => {
                if (!window.Recharts) return <div className="flex items-center justify-center h-full text-slate-400 text-xs">åœ–è¡¨è¼‰å…¥ä¸­...</div>;
                const R = window.Recharts;
                const ChartComponent = R[type];
                if (!ChartComponent) return null;
                
                // 1.8.5 å¿…é ˆæŒ‡å®šæ˜ç¢ºé«˜åº¦ (é‡è¦)
                const containerStyle = { height: '300px', width: '100%', minHeight: '300px' };
                
                // ç¢ºä¿åœ¨ç”ŸæˆPDFæ™‚é—œé–‰å‹•ç•«
                const finalProps = { ...props, isAnimationActive: !isGeneratingPDF };

                if (type === 'RadarChart') {
                    return (
                        <div style={containerStyle}>
                            <R.ResponsiveContainer>
                                <ChartComponent {...finalProps}>
                                    {children}
                                </ChartComponent>
                            </R.ResponsiveContainer>
                        </div>
                    );
                }

                if (type === 'AreaChart') {
                    return (
                         <div style={containerStyle}>
                            <R.ResponsiveContainer>
                                <ChartComponent {...finalProps}>
                                    {children}
                                </ChartComponent>
                            </R.ResponsiveContainer>
                        </div>
                    );
                }
                
                if (type === 'ScatterChart') {
                    return (
                         <div style={containerStyle}>
                            <R.ResponsiveContainer>
                                <ChartComponent margin={{ top: 20, right: 30, bottom: 20, left: 20 }}>
                                    {children}
                                </ChartComponent>
                            </R.ResponsiveContainer>
                        </div>
                    );
                }

                return null;
            };
            
            // --- å®šç¾© PreviewContent (è§£æ±º ReferenceError) ---
            const PreviewContent = ({ tab }) => {
                const { swot } = data.intelligence;
                switch (tab) {
                    case 'intelligence':
                        return (
                            <div className="p-6">
                                <h2 className="text-2xl font-bold mb-4 text-slate-800">{data.brandName || 'å“ç‰Œåç¨±'} - æ·±åº¦æƒ…è³‡</h2>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                    <div className="bg-green-50 p-3 rounded border-l-4 border-green-500"><h4 className="font-bold text-green-700 text-sm mb-2">Strengths</h4><ul className="list-disc pl-4 text-xs text-slate-600 space-y-1">{swot.strengths.map((s,i)=><li key={i}>{s}</li>)}</ul></div>
                                    <div className="bg-red-50 p-3 rounded border-l-4 border-red-500"><h4 className="font-bold text-red-700 text-sm mb-2">Weaknesses</h4><ul className="list-disc pl-4 text-xs text-slate-600 space-y-1">{swot.weaknesses.map((s,i)=><li key={i}>{s}</li>)}</ul></div>
                                    <div className="bg-blue-50 p-3 rounded border-l-4 border-blue-500"><h4 className="font-bold text-blue-700 text-sm mb-2">Opportunities</h4><ul className="list-disc pl-4 text-xs text-slate-600 space-y-1">{swot.opportunities.map((s,i)=><li key={i}>{s}</li>)}</ul></div>
                                    <div className="bg-yellow-50 p-3 rounded border-l-4 border-yellow-500"><h4 className="font-bold text-yellow-700 text-sm mb-2">Threats</h4><ul className="list-disc pl-4 text-xs text-slate-600 space-y-1">{swot.threats.map((s,i)=><li key={i}>{s}</li>)}</ul></div>
                                </div>
                                <div className="h-64 bg-white rounded-xl border p-4 mb-4">
                                    <h4 className="text-sm font-bold mb-2 text-slate-600 flex items-center gap-2"><Icons.TrendingUp size={16}/> æœå°‹è¶¨å‹¢</h4>
                                    <SafeChart type="AreaChart" data={data.intelligence.monthlySearchVolume.map((v, i) => ({ name: data.intelligence.trendLabels[i], value: v }))} isAnimationActive={!isGeneratingPDF}>
                                        <window.Recharts.defs><linearGradient id="colorVol" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#4f46e5" stopOpacity={0.2}/><stop offset="95%" stopColor="#4f46e5" stopOpacity={0}/></linearGradient></window.Recharts.defs>
                                        <window.Recharts.CartesianGrid strokeDasharray="3 3" vertical={false} />
                                        <window.Recharts.XAxis dataKey="name" tick={{fontSize: 10}} tickLine={false} axisLine={false} />
                                        <window.Recharts.YAxis tick={{fontSize: 10}} axisLine={false} tickLine={false} label={{ value: 'ç†±åº¦ (0-100)', angle: -90, position: 'insideLeft', fontSize: 10, fill: '#94a3b8' }} />
                                        <window.Recharts.Tooltip contentStyle={{borderRadius: '8px', border: 'none'}} />
                                        <window.Recharts.Area type="monotone" dataKey="value" stroke="#4f46e5" fillOpacity={1} fill="url(#colorVol)" isAnimationActive={!isGeneratingPDF} />
                                    </SafeChart>
                                </div>
                            </div>
                        );
                    case 'competitors':
                         return (
                            <div className="p-6 flex flex-col items-center">
                                <h2 className="text-2xl font-bold mb-4 text-slate-800">ç«¶å“åˆ†æ</h2>
                                <div className="w-full h-[400px] md:h-[500px] bg-white border rounded-xl p-4 mb-6 relative">
                                     <div className="absolute top-2 right-2 z-10 flex flex-col gap-1 bg-white/80 p-2 rounded text-[10px]">
                                        <div className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-green-500"></span> æœ¬å“ç‰Œ</div>
                                        <div className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-blue-500"></span> åŒé¡å‹</div>
                                        <div className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-purple-500"></span> åŒåœ‹å®¶</div>
                                        <div className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-orange-500"></span> åŒé¢¨æ ¼</div>
                                    </div>
                                    <SafeChart type="ScatterChart" margin={{ top: 20, right: 30, bottom: 20, left: 20 }}>
                                        <window.Recharts.CartesianGrid strokeDasharray="3 3" />
                                        <window.Recharts.XAxis type="number" dataKey="price" name="åƒ¹æ ¼" domain={[0, 100]} label={{ value: 'åƒ¹æ ¼', position: 'bottom', offset: 0, fontSize: 12 }} tick={{fontSize: 10}} />
                                        <window.Recharts.YAxis type="number" dataKey="quality" name="å“è³ª" domain={[0, 100]} label={{ value: 'é¢¨æ ¼ç¨ç‰¹æ€§ (å¤§çœ¾ â†’ å‰è¡›)', angle: -90, position: 'left', fontSize: 12 }} tick={{fontSize: 10}} />
                                        <window.Recharts.ZAxis type="number" dataKey="brandHeat" range={[100, 1000]} name="ç†±åº¦" />
                                        <window.Recharts.Tooltip cursor={{ strokeDasharray: '3 3' }} content={({ active, payload }) => {
                                            if (active && payload && payload.length) {
                                                const d = payload[0].payload;
                                                return (
                                                    <div className="bg-white p-2 border border-slate-200 rounded shadow text-xs">
                                                        <p className="font-bold mb-1" style={{color: getTypeColor(d.type)}}>{d.name} <span className="text-[10px] px-1 bg-slate-100 rounded text-slate-500 ml-1">{d.type || 'æœªåˆ†é¡'}</span></p>
                                                        <p className="text-xs text-gray-500 mb-1">"{d.feature || ''}"</p>
                                                        <hr className="my-1 border-slate-100"/>
                                                        <p>åƒ¹æ ¼: {getScoreLabel(d.price, 'price')} ({d.price})</p>
                                                        <p>å“è³ª: {getScoreLabel(d.quality, 'quality')} ({d.quality})</p>
                                                        <p className="text-red-500">ç†±åº¦: {getScoreLabel(d.brandHeat, 'brandHeat')} ({d.brandHeat})</p>
                                                    </div>
                                                );
                                            }
                                            return null;
                                        }} />
                                        <window.Recharts.Scatter name="å¸‚å ´å“ç‰Œ" data={data.competitors} fill="#8884d8" isAnimationActive={!isGeneratingPDF}>
                                            {data.competitors.map((entry, index) => (
                                                <window.Recharts.Cell key={`cell-${index}`} fill={getTypeColor(entry.type)} />
                                            ))}
                                            <window.Recharts.LabelList dataKey="name" position="top" style={{ fill: '#555', fontSize: '10px', fontWeight: 'bold' }}/>
                                        </window.Recharts.Scatter>
                                    </SafeChart>
                                </div>
                                <div className="w-full overflow-x-auto">
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-slate-100"><tr><th className="p-3 whitespace-nowrap">å“ç‰Œ</th><th className="p-3 whitespace-nowrap">é¡åˆ¥</th><th className="p-3 whitespace-nowrap">åƒ¹æ ¼å®šä½</th><th className="p-3 whitespace-nowrap">å“è³ªå±¤ç´š</th><th className="p-3 whitespace-nowrap">ç†±åº¦</th></tr></thead>
                                        <tbody>
                                            {data.competitors.map((c,i)=>(
                                                <tr key={i} className="border-b"><td className="p-3 font-bold whitespace-nowrap">{c.name}</td><td className="p-3 text-slate-500 whitespace-nowrap">{c.type || '-'}</td><td className="p-3 text-slate-600">{getScoreLabel(c.price,'price')}</td><td className="p-3 text-slate-600">{getScoreLabel(c.quality,'quality')}</td><td className="p-3 text-red-500">{getScoreLabel(c.brandHeat,'brandHeat')}</td></tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                         );
                    case 'positioning':
                        return (
                            <div className="p-6 flex flex-col items-center">
                                <h2 className="text-2xl font-bold mb-4 text-slate-800">å“ç‰Œå®šä½</h2>
                                <div className="w-full h-80 md:h-96">
                                    <SafeChart type="RadarChart" cx="50%" cy="50%" outerRadius="65%" data={data.positioning.attributes} isAnimationActive={!isGeneratingPDF}>
                                        <window.Recharts.PolarGrid />
                                        <window.Recharts.PolarAngleAxis dataKey="subject" tick={{ fill: '#64748b', fontSize: 12 }} />
                                        <window.Recharts.PolarRadiusAxis angle={30} domain={[0, 100]} />
                                        <window.Recharts.Radar name={data.brandName} dataKey="A" stroke="#2563eb" strokeWidth={3} fill="#3b82f6" fillOpacity={0.4} isAnimationActive={!isGeneratingPDF} />
                                        <window.Recharts.Tooltip />
                                    </SafeChart>
                                </div>
                                <div className="mt-6 grid grid-cols-1 gap-4 w-full">
                                    <div className="p-4 bg-indigo-50 rounded-lg"><h4 className="font-bold text-indigo-800 mb-2">é¡˜æ™¯</h4><p className="text-sm text-slate-700">{data.positioning.vision}</p></div>
                                    <div className="p-4 bg-purple-50 rounded-lg"><h4 className="font-bold text-purple-800 mb-2">ä½¿å‘½</h4><p className="text-sm text-slate-700">{data.positioning.mission}</p></div>
                                </div>
                            </div>
                        );
                    case 'audience':
                        return (
                            <div className="p-6">
                                <h2 className="text-2xl font-bold mb-4 text-slate-800">ç›®æ¨™å®¢ç¾¤ (TA)</h2>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    {data.targetAudience.map((ta, idx) => (
                                        <div key={idx} className="bg-white border rounded-xl p-4 shadow-sm">
                                            <div className="flex items-center gap-3 mb-3">
                                                <div className="bg-blue-100 p-2 rounded-full text-blue-600"><Icons.Users size={20}/></div>
                                                <div><div className="font-bold text-lg">{ta.name}</div><div className="text-xs text-slate-500">{ta.age}</div></div>
                                            </div>
                                            <div className="space-y-2 text-xs">
                                                <div className="p-2 bg-slate-50 rounded"><strong>æ”¶å…¥:</strong> {ta.income}</div>
                                                <div className="p-2 bg-slate-50 rounded"><strong>ç—›é»:</strong> {ta.painPoint}</div>
                                                <div className="p-2 bg-slate-50 rounded"><strong>èˆˆè¶£:</strong> {ta.hobby}</div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        );
                    case 'businessModel':
                        return (
                            <div className="p-6 h-full">
                                <h2 className="text-2xl font-bold mb-4 text-slate-800">å•†æ¥­æ¨¡å¼ç•«å¸ƒ</h2>
                                <div className="grid grid-cols-5 grid-rows-[200px_200px_100px] gap-2 min-h-[500px] border-2 border-slate-800 bg-slate-800 p-2 rounded-lg h-full">
                                    <div className="bg-white p-2 rounded row-span-2 col-span-1 overflow-y-auto"><h4 className="font-bold text-xs text-slate-500 mb-1">é—œéµåˆä½œå¤¥ä¼´</h4><ul className="list-disc pl-4 text-xs text-slate-800">{data.businessModel.partners.map((item,i)=><li key={i}>{item}</li>)}</ul></div>
                                    
                                    <div className="col-span-1 row-span-2 flex flex-col gap-2">
                                        <div className="bg-white p-2 rounded flex-1 overflow-y-auto"><h4 className="font-bold text-xs text-slate-500 mb-1">é—œéµæ´»å‹•</h4><ul className="list-disc pl-4 text-xs text-slate-800">{data.businessModel.activities.map((item,i)=><li key={i}>{item}</li>)}</ul></div>
                                        <div className="bg-white p-2 rounded flex-1 overflow-y-auto"><h4 className="font-bold text-xs text-slate-500 mb-1">é—œéµè³‡æº</h4><ul className="list-disc pl-4 text-xs text-slate-800">{data.businessModel.resources.map((item,i)=><li key={i}>{item}</li>)}</ul></div>
                                    </div>
                                    
                                    <div className="bg-white p-2 rounded row-span-2 col-span-1 overflow-y-auto"><h4 className="font-bold text-xs text-blue-600 mb-1">åƒ¹å€¼ä¸»å¼µ</h4><ul className="list-disc pl-4 text-xs text-slate-800">{data.businessModel.valueProp.map((item,i)=><li key={i}>{item}</li>)}</ul></div>
                                    
                                    <div className="col-span-1 row-span-2 flex flex-col gap-2">
                                        <div className="bg-white p-2 rounded flex-1 overflow-y-auto"><h4 className="font-bold text-xs text-slate-500 mb-1">é¡§å®¢é—œä¿‚</h4><ul className="list-disc pl-4 text-xs text-slate-800">{data.businessModel.relationships.map((item,i)=><li key={i}>{item}</li>)}</ul></div>
                                        <div className="bg-white p-2 rounded flex-1 overflow-y-auto"><h4 className="font-bold text-xs text-slate-500 mb-1">é€šè·¯</h4><ul className="list-disc pl-4 text-xs text-slate-800">{data.businessModel.channels.map((item,i)=><li key={i}>{item}</li>)}</ul></div>
                                    </div>
                                    
                                    <div className="bg-white p-2 rounded row-span-2 col-span-1 overflow-y-auto"><h4 className="font-bold text-xs text-slate-500 mb-1">ç›®æ¨™å®¢ç¾¤</h4><ul className="list-disc pl-4 text-xs text-slate-800">{data.businessModel.segments.map((item,i)=><li key={i}>{item}</li>)}</ul></div>
                                    
                                    <div className="bg-white p-2 rounded col-span-2.5 row-start-3 col-start-1 overflow-y-auto"><h4 className="font-bold text-xs text-slate-500 mb-1">æˆæœ¬çµæ§‹</h4><div className="flex flex-wrap gap-2">{data.businessModel.costStructure.map((item,i)=><span key={i} className="bg-red-50 text-red-700 text-[10px] px-2 py-1 rounded">{item}</span>)}</div></div>
                                    <div className="bg-white p-2 rounded col-span-2.5 row-start-3 col-start-3 overflow-y-auto"><h4 className="font-bold text-xs text-slate-500 mb-1">æ”¶ç›Šæµ</h4><div className="flex flex-wrap gap-2">{data.businessModel.revenueStreams.map((item,i)=><span key={i} className="bg-green-50 text-green-700 text-[10px] px-2 py-1 rounded">{item}</span>)}</div></div>
                                </div>
                            </div>
                         );
                    default: return <div className="p-10 text-center text-slate-400">è«‹é¸æ“‡å·¦å´åŠŸèƒ½é€²è¡Œé è¦½</div>;
                }
            }
            
            // å®šç¾© renderPreviewWrapper (è§£æ±º ReferenceError)
            const renderPreviewWrapper = () => {
                return (
                    <div className="h-full p-6 overflow-y-auto custom-scrollbar pb-20 md:pb-6">
                        <PreviewContent tab={activeTab} />
                    </div>
                );
            };

            // renderEditor å®šç¾© (è§£æ±º ReferenceError)
            const renderEditor = () => {
                const { swot } = data.intelligence;
                switch (activeTab) {
                    case 'intelligence':
                        return (
                            <div className="space-y-6 animate-fadeIn pb-20 md:pb-0">
                                <SectionTitle icon={Icons.Globe} title="å“ç‰Œæ·±åº¦æƒ…è³‡èˆ‡ SWOT" subtitle="å…¨æ–¹ä½å¸‚å ´æƒæ" />
                                <div className="bg-gradient-to-br from-indigo-50 to-blue-50 p-4 rounded-xl border border-indigo-100 shadow-sm space-y-4">
                                    <div className="flex justify-between items-start mb-2">
                                        <label className="text-sm font-bold text-indigo-900 flex items-center gap-2"><Icons.Sparkles size={16}/> AI æ·±åº¦åˆ†æ</label>
                                        
                                        {apiKey ? (
                                            <div className="flex items-center gap-2 bg-green-100 p-1.5 rounded border border-green-200 text-green-700 text-xs font-bold"><Icons.Lock size={14} /> ç³»çµ±æˆæ¬Šå·²é€£çµ</div>
                                        ) : (
                                            <div className="flex items-center gap-2 bg-white/60 p-1 rounded border border-indigo-100"><Icons.Key size={14} className="text-indigo-400" /><input type="password" placeholder="è«‹è¼¸å…¥ Key" value={customApiKey} onChange={(e) => setCustomApiKey(e.target.value)} className="bg-transparent text-xs outline-none w-24" /></div>
                                        )}
                                    </div>
                                    <div className="flex gap-2">
                                        <input className="flex-1 border border-indigo-200 rounded-lg p-2 text-sm" placeholder="è¼¸å…¥å“ç‰Œåç¨±..." value={data.searchQuery} onChange={(e)=>setData({...data, searchQuery:e.target.value})} />
                                        <button onClick={handleSearch} disabled={!data.searchQuery || searchStatus!=='idle'&&searchStatus!=='complete'} className="bg-indigo-600 text-white px-4 rounded-lg text-sm flex items-center gap-2 hover:bg-indigo-700 disabled:bg-slate-300">
                                            {searchStatus!=='idle'&&searchStatus!=='complete' ? <Icons.Loader2 className="animate-spin" size={16}/> : <Icons.Search size={16}/>} åˆ†æ
                                        </button>
                                    </div>
                                    {errorMsg && (
                                        <div className="text-xs text-red-500 p-2 bg-red-50 rounded border border-red-100">
                                            <div className="flex items-center gap-1 font-bold mb-1"><Icons.AlertCircle size={12}/> éŒ¯èª¤ï¼š{errorMsg}</div>
                                            {rawAiResponse && (
                                                <details className="mt-1">
                                                    <summary className="cursor-pointer text-red-400">æŸ¥çœ‹åŸå§‹å›æ‡‰ (é™¤éŒ¯ç”¨)</summary>
                                                    <pre className="mt-2 p-2 bg-slate-800 text-white rounded overflow-x-auto text-[10px] whitespace-pre-wrap">
                                                        {rawAiResponse}
                                                    </pre>
                                                </details>
                                            )}
                                        </div>
                                    )}
                                    {searchStatus!=='idle' && searchStatus!=='complete' && !errorMsg && (
                                        <div className="space-y-1">
                                            {searchLog.map((log,i)=><div key={i} className="text-xs text-slate-600 flex items-center gap-1 animate-fadeIn"><Icons.CheckCircle2 size={10} className="text-green-500"/>{log}</div>)}
                                        </div>
                                    )}
                                </div>
                                {searchStatus==='complete' && (
                                    <div className="animate-fadeIn space-y-6">
                                        <div className="bg-white border border-slate-200 rounded-xl p-4 shadow-sm">
                                            <h3 className="text-sm font-bold text-slate-800 mb-3 flex gap-2"><Icons.Shield size={16} className="text-blue-600"/> SWOT åˆ†æ</h3>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                <div className="p-2 bg-green-50 border-l-2 border-green-500 rounded"><div className="text-xs font-bold text-green-700 mb-1">Strengths</div><ul className="list-disc pl-3 text-[10px] text-slate-600">{swot.strengths.map((s,i)=><li key={i}>{s}</li>)}</ul></div>
                                                <div className="p-2 bg-red-50 border-l-2 border-red-500 rounded"><div className="text-xs font-bold text-red-700 mb-1">Weaknesses</div><ul className="list-disc pl-3 text-[10px] text-slate-600">{swot.weaknesses.map((s,i)=><li key={i}>{s}</li>)}</ul></div>
                                                <div className="p-2 bg-blue-50 border-l-2 border-blue-500 rounded"><div className="text-xs font-bold text-blue-700 mb-1">Opportunities</div><ul className="list-disc pl-3 text-[10px] text-slate-600">{swot.opportunities.map((s,i)=><li key={i}>{s}</li>)}</ul></div>
                                                <div className="p-2 bg-yellow-50 border-l-2 border-yellow-500 rounded"><div className="text-xs font-bold text-yellow-700 mb-1">Threats</div><ul className="list-disc pl-3 text-[10px] text-slate-600">{swot.threats.map((s,i)=><li key={i}>{s}</li>)}</ul></div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        );
                    case 'positioning':
                        return (
                            <div className="space-y-6 animate-fadeIn pb-20 md:pb-0">
                                <SectionTitle icon={Icons.Target} title="å“ç‰Œå®šä½" subtitle="æ ¸å¿ƒåƒ¹å€¼èˆ‡å±¬æ€§" />
                                <div className="space-y-4">
                                    <div><label className="text-xs text-slate-500">å“ç‰Œåç¨±</label><input className="w-full border p-2 rounded" value={data.brandName} onChange={(e)=>setData({...data, brandName:e.target.value})} /></div>
                                    <div><label className="text-xs text-slate-500">é¡˜æ™¯</label><textarea className="w-full border p-2 rounded" rows="2" value={data.positioning.vision} onChange={(e)=>handleNestedChange('positioning','vision',e.target.value)} /></div>
                                    <div className="h-64 w-full border rounded p-2 bg-white">
                                        <SafeChart type="RadarChart" cx="50%" cy="50%" outerRadius="80%" data={data.positioning.attributes} isAnimationActive={!isGeneratingPDF}>
                                            <window.Recharts.PolarGrid />
                                            <window.Recharts.PolarAngleAxis dataKey="subject" tick={{ fill: '#64748b', fontSize: 12 }} />
                                            <window.Recharts.PolarRadiusAxis angle={30} domain={[0, 100]} />
                                            <window.Recharts.Radar name={data.brandName} dataKey="A" stroke="#2563eb" strokeWidth={3} fill="#3b82f6" fillOpacity={0.4} />
                                            <window.Recharts.Tooltip />
                                        </SafeChart>
                                    </div>
                                </div>
                            </div>
                        );
                    case 'competitors':
                        return (
                            <div className="space-y-6 animate-fadeIn pb-20 md:pb-0">
                                <SectionTitle icon={Icons.BarChart2} title="ç«¶å“åˆ†æ" subtitle="å®šä½åœ°åœ–èˆ‡æ•¸æ“š" />
                                <div className="w-full h-80 bg-white border rounded-xl p-4">
                                    <SafeChart type="ScatterChart" />
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-xs text-left">
                                        <thead className="bg-slate-100"><tr><th className="p-2">å“ç‰Œ</th><th className="p-2">é¡åˆ¥</th><th className="p-2">åƒ¹æ ¼</th><th className="p-2">å“è³ª</th><th className="p-2">ç†±åº¦</th></tr></thead>
                                        <tbody>
                                            {data.competitors.map((c,i)=>(
                                                <tr key={i} className="border-b"><td className="p-2 font-bold">{c.name}</td><td className="p-2 text-slate-500">{c.type || '-'}</td><td className="p-2">{getScoreLabel(c.price,'price')}</td><td className="p-2">{getScoreLabel(c.quality,'quality')}</td><td className="p-2 text-red-500">{getScoreLabel(c.brandHeat,'brandHeat')}</td></tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        );
                    case 'audience':
                        return (
                            <div className="space-y-6 animate-fadeIn pb-20 md:pb-0">
                                <SectionTitle icon={Icons.Users} title="ç›®æ¨™å®¢ç¾¤" subtitle="AI è‡ªå‹•ç”Ÿæˆèˆ‡ç·¨è¼¯" />
                                <div className="grid grid-cols-1 gap-4">
                                    {data.targetAudience.map((ta, idx) => (
                                        <div key={idx} className="bg-slate-50 p-3 rounded border border-slate-200">
                                            <input className="w-full bg-white border border-slate-300 rounded p-2 text-sm mb-2 font-bold" value={ta.name} onChange={(e) => {
                                                const newAudience = [...data.targetAudience];
                                                newAudience[idx].name = e.target.value;
                                                setData({...data, targetAudience: newAudience});
                                            }} />
                                            <input className="w-full bg-white border border-slate-300 rounded p-2 text-xs mb-2" value={ta.age} onChange={(e) => {
                                                const newAudience = [...data.targetAudience];
                                                newAudience[idx].age = e.target.value;
                                                setData({...data, targetAudience: newAudience});
                                            }} />
                                             <textarea className="w-full bg-white border border-slate-300 rounded p-2 text-xs" rows="2" value={ta.painPoint} onChange={(e) => {
                                                const newAudience = [...data.targetAudience];
                                                newAudience[idx].painPoint = e.target.value;
                                                setData({...data, targetAudience: newAudience});
                                            }} />
                                        </div>
                                    ))}
                                </div>
                            </div>
                        );
                    case 'businessModel':
                        return (
                            <div className="space-y-6 animate-fadeIn pb-20 md:pb-0">
                                <SectionTitle icon={Icons.Layout} title="å•†æ¥­æ¨¡å¼ç•«å¸ƒ" subtitle="AI è‡ªå‹•ç”Ÿæˆèˆ‡ç·¨è¼¯" />
                                <div className="grid grid-cols-1 gap-4">
                                    {Object.entries(data.businessModel).map(([key, val]) => (
                                        <div key={key} className="bg-slate-50 p-3 rounded border border-slate-200">
                                            <label className="block text-xs font-bold text-slate-500 uppercase mb-2">{BMC_TITLES[key] || key}</label>
                                            <textarea className="w-full bg-white border border-slate-300 rounded p-2 text-sm" rows="2" value={val.join(', ')} onChange={(e) => {
                                                const newVal = e.target.value.split(',').map(s => s.trim());
                                                setData({...data, businessModel: {...data.businessModel, [key]: newVal}});
                                            }} />
                                        </div>
                                    ))}
                                </div>
                            </div>
                        );
                    default: return <div className="p-4 text-slate-400">è«‹é¸æ“‡åŠŸèƒ½æ¨¡çµ„</div>;
                }
            };

            return (
                <div id="pdf-export-target" className={`min-h-screen bg-slate-50 flex flex-col font-sans h-full fixed w-full ${isGeneratingPDF ? 'pdf-mode' : ''}`}>
                    {/* PDF ç”Ÿæˆæ™‚çš„éš±è—å®¹å™¨ */}
                    {isGeneratingPDF && (
                        <div className="fixed inset-0 z-[100] bg-white overflow-y-auto">
                            <div id="print-intelligence" className="pdf-section"><PreviewContent tab="intelligence" /></div>
                            <div id="print-positioning" className="pdf-section"><PreviewContent tab="positioning" /></div>
                            <div id="print-audience" className="pdf-section"><PreviewContent tab="audience" /></div>
                            <div id="print-competitors" className="pdf-section"><PreviewContent tab="competitors" /></div>
                            <div id="print-bmc" className="pdf-section"><PreviewContent tab="businessModel" /></div>
                        </div>
                    )}

                    {/* ä¸€èˆ¬é¡¯ç¤ºæ¨¡å¼ Header */}
                    {!isGeneratingPDF && (
                    <header className="bg-white border-b h-14 px-4 flex items-center justify-between shrink-0 z-20">
                        <div className="flex items-center gap-2"><div className="bg-blue-600 p-1.5 rounded"><Icons.Brain className="text-white" size={18}/></div><h1 className="font-bold text-md md:text-lg">Krang</h1></div>
                        
                        <div className="flex md:hidden bg-slate-100 rounded-lg p-1">
                            <button onClick={()=>setIsPresentationMode(false)} className={`px-3 py-1 text-xs rounded-md transition-all ${!isPresentationMode?'bg-white shadow text-blue-600 font-bold':'text-slate-500'}`}>ç·¨è¼¯</button>
                            <button onClick={()=>setIsPresentationMode(true)} className={`px-3 py-1 text-xs rounded-md transition-all ${isPresentationMode?'bg-white shadow text-blue-600 font-bold':'text-slate-500'}`}>é è¦½</button>
                        </div>

                        <div className="hidden md:flex gap-2">
                             <button id="download-btn" onClick={handleDownloadPDF} className="flex items-center gap-2 px-3 py-1.5 bg-red-600 text-white rounded hover:bg-red-700 text-sm shadow-sm"><Icons.Save size={16}/> ä¸‹è¼‰ PDF</button>
                            <button onClick={()=>setIsPresentationMode(true)} className="flex items-center gap-2 px-3 py-1.5 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm"><Icons.Presentation size={16}/> ç°¡å ±æ¨¡å¼</button>
                        </div>
                    </header>
                    )}

                    {/* Main Content */}
                    {!isGeneratingPDF && (
                    <div className="flex flex-1 overflow-hidden relative">
                        {/* Desktop Sidebar / Mobile Bottom Nav */}
                        <nav className="hidden md:flex w-64 bg-white border-r flex-col overflow-y-auto p-4 space-y-1 shrink-0">
                            {navItems.map(item => <button key={item.id} onClick={()=>setActiveTab(item.id)} className={`w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg transition-all ${activeTab===item.id?'bg-blue-50 text-blue-600 shadow-sm':'text-slate-500 hover:bg-slate-50'}`}><item.icon size={18}/>{item.label}</button>)}
                        </nav>

                        {/* Mobile Bottom Navigation */}
                        {!isPresentationMode && (
                            <div className="md:hidden fixed bottom-0 w-full bg-white border-t flex justify-around py-2 z-30">
                                {navItems.map(item => (
                                    <button key={item.id} onClick={()=>setActiveTab(item.id)} className={`flex flex-col items-center p-1 ${activeTab===item.id?'text-blue-600':'text-slate-400'}`}>
                                        <item.icon size={20} />
                                        <span className="text-[10px] mt-1">{item.label.slice(0,2)}</span>
                                    </button>
                                ))}
                            </div>
                        )}

                        <main className="flex-1 flex flex-col md:flex-row overflow-hidden relative pb-16 md:pb-0">
                            {/* Editor Pane (æ‰‹æ©Ÿç‰ˆåœ¨ç°¡å ±æ¨¡å¼ä¸‹éš±è—) */}
                            <div className={`flex-1 p-4 md:p-8 overflow-y-auto bg-slate-50/50 border-r ${isPresentationMode ? 'hidden md:block' : 'block'}`}>
                                {renderEditor()}
                            </div>

                            {/* Desktop Preview Pane (æ‰‹æ©Ÿç‰ˆéš±è—ï¼Œåªåœ¨ Modal é¡¯ç¤º) */}
                            <div className="hidden md:block flex-1 bg-white p-8 overflow-y-auto relative">
                                <div className="h-full border-2 border-dashed border-slate-100 rounded-xl flex flex-col overflow-hidden relative">
                                    <div className="absolute top-4 right-4 text-[10px] font-bold text-slate-300 uppercase z-10">Live Dashboard</div>
                                    {renderPreviewWrapper()}
                                </div>
                            </div>
                            
                             {isPresentationMode && (
                                <div className="md:hidden absolute inset-0 bg-white z-20 overflow-y-auto">
                                    {renderPreviewWrapper()}
                                </div>
                            )}
                        </main>
                    </div>
                    )}

                    {isPresentationMode && !isGeneratingPDF && (
                        <div className="hidden md:flex fixed inset-0 z-50 bg-slate-900 flex-col text-white">
                            <div className="flex justify-between items-center p-4 border-b border-slate-700">
                                <div className="flex items-center gap-2"><span className="font-mono text-sm text-slate-400">BRAND INTELLIGENCE DECK</span></div>
                                <button onClick={()=>setIsPresentationMode(false)} className="bg-white text-slate-900 px-4 py-2 rounded font-bold hover:bg-slate-200">é€€å‡º</button>
                            </div>
                            <div className="flex-1 p-8 flex justify-center overflow-auto bg-slate-100 text-slate-900">
                                <div className="w-full max-w-5xl bg-white rounded-2xl shadow-2xl overflow-hidden">{renderPreviewWrapper()}</div>
                            </div>
                            <div className="p-4 bg-slate-800 flex justify-center gap-4">
                                {navItems.map(item => <button key={item.id} onClick={()=>setActiveTab(item.id)} className={`px-4 py-2 rounded text-sm ${activeTab===item.id?'bg-blue-600':'hover:bg-slate-700'}`}>{item.label}</button>)}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<BrandStrategyApp />, document.getElementById('root'));
    </script>
</body>
</html>
